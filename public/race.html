<!doctype html>
<html lang="zh-HK">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>賽事詳情 - HKJC 面板</title>
<style>
  :root{
    --bg: #0f1115;
    --panel: #171a21;
    --muted: #9aa4b2;
    --text: #e6ebf2;
    --primary: #4da3ff;
    --accent: #7ee081;
    --danger: #ff6b6b;
    --border: #2a2f3a;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg: #f6f7fb; --panel:#fff; --muted:#5e6a77; --text:#1b2430;
      --primary:#1864ff; --accent:#129b45; --danger:#c42525; --border:#e7eaf0;
    }
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto}

  .appbar{position:sticky;top:0;z-index:40;background:var(--panel);border-bottom:1px solid var(--border)}
  .appbar .row{display:flex;align-items:center;gap:.75rem;padding:.6rem 1rem}
  .btn{border:1px solid var(--border);background:transparent;color:var(--text);padding:.4rem .7rem;border-radius:.55rem;cursor:pointer}
  .btn.primary{background:var(--primary);border-color:transparent;color:#fff}
  .muted{color:var(--muted)}

  main{padding:1rem}
  .tabs{display:flex;gap:.25rem;border-bottom:1px solid var(--border);padding:.2rem}
  .tab{padding:.55rem .9rem;border-radius:.55rem;cursor:pointer;color:var(--muted)}
  .tab.active{background:rgba(77,163,255,.15);color:var(--text)}
  .panel{display:none;padding:1rem 0}
  .panel.active{display:block}

  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:.8rem}
  .card{border:1px solid var(--border);border-radius:.65rem;padding:.9rem;background:var(--panel)}
  .kv{display:grid;grid-template-columns:120px 1fr;gap:.35rem .6rem}
  .kv div{padding:.15rem 0;border-bottom:1px dashed var(--border)}

  .table-wrap{background:var(--panel);border:1px solid var(--border);border-radius:.8rem;overflow:hidden}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding:.4rem .6rem;border-bottom:1px solid rgba(255,255,255,.03)}
  .table th{color:var(--muted);font-weight:600;font-size:12px}
  .table tr:nth-child(even){background:rgba(255,255,255,0.02)}

  .section-title{margin:.3rem 0 .4rem;font-size:15px;font-weight:600}
  .pill{display:inline-flex;align-items:center;padding:0 .5rem;border-radius:999px;background:rgba(77,163,255,.18);color:var(--primary);font-size:11px;margin-left:.4rem}

  @media (max-width:600px){
    .kv{grid-template-columns:1fr}
    .table-wrap{overflow-x:auto}
  }
  .odds-grid-wrapper{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
    gap:.8rem;
    margin-top:1rem;
  }
  .odds-grid h4{font-size:14px}
  .table td.odds-empty{color:var(--muted);font-size:12px}
  .table td.odds-cell small{display:block;font-size:11px;color:var(--muted)}
  .odds-cell-hot{
    color:#ff6b6b;
    font-weight:600;
  }
  .odds-cell-warm{
    color:#ffb347;
    font-weight:600;
  }
</style>
</head>
<body>
<div class="appbar">
  <div class="row">
    <button class="btn" id="btnBack">← 返回賽日</button>
    <div>
      <div id="title-main"><strong>賽事詳情</strong></div>
      <div class="muted" id="title-sub"></div>
    </div>
    <div style="flex:1"></div>
    <button class="btn primary" id="btnReload">重新載入</button>
  </div>
</div>

<main>
  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="basic">基本資料</div>
    <div class="tab" data-tab="odds">賠率 / 投注池</div>
    <div class="tab" data-tab="runners">馬匹名單</div>
    <div class="tab" data-tab="analysis">賽事分析</div>
    <div class="tab" data-tab="results">賽果</div>
  </div>

  <section class="panel active" id="panel-basic">
    <div class="cards" id="basicCards"></div>
  </section>

  <!-- 賠率 panel -->
  <section class="panel" id="panel-odds">
    <h3 style="margin:0 0 .4rem;">最新賠率</h3>
    <div class="table-wrap">
      <table class="table" id="oddsLiveTable">
        <thead>
          <tr>
            <th>馬號</th>
            <th>馬名</th>
            <th>獨贏</th>
            <th>位置</th>
            <th class="muted">最後更新</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="odds-grid-wrapper">
      <div class="odds-grid">
        <h4 style="margin:.8rem 0 .3rem;">獨贏最近 10 筆</h4>
        <div class="table-wrap">
          <table class="table" id="oddsHistWIN">
            <thead>
              <tr>
                <th>馬號</th>
                <th>馬名</th>
                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
                <th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="odds-grid">
        <h4 style="margin:.8rem 0 .3rem;">位置最近 10 筆</h4>
        <div class="table-wrap">
          <table class="table" id="oddsHistPLA">
            <thead>
              <tr>
                <th>馬號</th>
                <th>馬名</th>
                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
                <th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <p class="muted" style="margin-top:.4rem;font-size:12px;">
      每格顯示最新 → 較舊賠率，滑鼠移上去可睇時間；頁面會定時自動重新整理。
    </p>
  </section>

  <!-- 馬匹名單 -->
  <section class="panel" id="panel-runners">
    <div class="table-wrap" style="overflow-x:auto;">
      <table class="table" id="runnersTable">
        <thead>
          <tr>
            <th>馬號</th>
            <th>馬名（中）</th>
            <th>馬名（英）</th>
            <th>馬匹編號</th>
            <th>檔位</th>
            <th>騎師</th>
            <th>練馬師</th>
            <th>評分</th>
            <th>評分變動</th>
            <th>負磅 (lb)</th>
            <th>出馬磅</th>
            <th>年齡</th>
            <th>性別</th>
            <th>WFA</th>
            <th>今季獎金</th>
            <th>優先權</th>
            <th>上次出賽至今</th>
            <th>馬主</th>
            <th>父系</th>
            <th>母系</th>
            <th>進口類別</th>
            <th>馬衣</th>
            <th>品牌</th>
            <th>配備</th>
            <th>近績</th>
            <th>退出</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- 賽事分析 -->
  <section class="panel" id="panel-analysis">
    <!-- 1) 馬匹整體統計 -->
    <h3 class="section-title">
      賽事分析 <span class="pill">馬匹整體統計</span>
    </h3>
    <div class="table-wrap" style="overflow-x:auto;">
      <table class="table" id="analysisTable">
        <thead>
          <tr>
            <th>馬號</th>
            <th>馬名</th>
            <th>次數</th>
            <th>冠</th>
            <th>亞</th>
            <th>季</th>
            <th>第4</th>
            <th>勝出率%</th>
            <th>入Q率%</th>
            <th>入位率%</th>
            <th>入四率%</th>
            <th>得分</th>
            <th>全部計%</th>
            <th>10記綠＝50分</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="14" class="muted">載入中…</td></tr>
        </tbody>
      </table>
    </div>

    <!-- 2) 負磅統計 -->
    <h3 class="section-title" style="margin-top:.9rem;">
      負磅統計 <span class="pill">按負磅區間歷史表現</span>
    </h3>
    <div class="table-wrap" style="overflow-x:auto;">
      <table class="table" id="weightTable">
        <thead>
          <tr>
            <th>馬號</th>
            <th>馬名</th>
            <th>負磅區間</th>
            <th>次數</th>
            <th>冠</th>
            <th>亞</th>
            <th>季</th>
            <th>第4</th>
            <th>勝出率%</th>
            <th>入Q率%</th>
            <th>入位率%</th>
            <th>入四率%</th>
            <th>得分</th>
            <th>全部計%</th>
            <th>10記綠＝50分</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="15" class="muted">暫未接駁負磅統計資料。</td></tr>
        </tbody>
      </table>
    </div>

    <!-- 3) 檔位統計 -->
    <h3 class="section-title" style="margin-top:.9rem;">
      檔位統計 <span class="pill">同場地 / 路程歷史</span>
    </h3>
    <div class="table-wrap" style="overflow-x:auto;">
      <table class="table" id="drawTable">
        <thead>
          <tr>
            <th>馬號</th>
            <th>馬名</th>
            <th>檔位</th>
            <th>次數</th>
            <th>冠</th>
            <th>亞</th>
            <th>季</th>
            <th>第4</th>
            <th>勝出率%</th>
            <th>入Q率%</th>
            <th>入位率%</th>
            <th>入四率%</th>
            <th>得分</th>
            <th>全部計%</th>
            <th>10記綠＝50分</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="15" class="muted">載入中…</td></tr>
        </tbody>
      </table>
    </div>

    <!-- 3.5) 馬匹檔位統計 -->
    <h3 class="section-title" style="margin-top:.9rem;">
      馬匹檔位統計 <span class="pill">按馬匹拆分檔位表現</span>
    </h3>
    <div class="table-wrap" style="overflow-x:auto;">
      <table class="table" id="horseDrawTable">
        <thead>
          <tr>
            <th>馬號</th>
            <th>馬名</th>
            <th>檔位</th>
            <th>次數</th>
            <th>冠</th>
            <th>亞</th>
            <th>季</th>
            <th>第4</th>
            <th>勝出率%</th>
            <th>入Q率%</th>
            <th>入位率%</th>
            <th>入四率%</th>
            <th>得分</th>
            <th>全部計%</th>
            <th>10記綠＝50分</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="15" class="muted">暫未接駁馬匹檔位統計。</td></tr>
        </tbody>
      </table>
    </div>

    <!-- 4) 馬匹路程統計 -->
    <h3 class="section-title" style="margin-top:.9rem;">
      馬匹路程統計 <span class="pill">同場地 / 不同途程</span>
    </h3>
    <div class="table-wrap" style="overflow-x:auto;">
      <table class="table" id="horseDistTable">
        <thead>
          <tr>
            <th>馬號</th>
            <th>馬名</th>
            <th>場地</th>
            <th>路程 (m)</th>
            <th>次數</th>
            <th>冠</th>
            <th>亞</th>
            <th>季</th>
            <th>第4</th>
            <th>勝出率%</th>
            <th>入Q率%</th>
            <th>入位率%</th>
            <th>入四率%</th>
            <th>得分</th>
            <th>全部計%</th>
            <th>10記綠＝50分</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="16" class="muted">暫未接駁馬匹路程統計。</td></tr>
        </tbody>
      </table>
    </div>

    <!-- 5) 騎師路程統計 -->
    <h3 class="section-title" style="margin-top:.9rem;">
      騎師路程統計 <span class="pill">騎師同場地 / 路程表現</span>
    </h3>
    <div class="table-wrap" style="overflow-x:auto;">
      <table class="table" id="jockeyDistTable">
        <thead>
          <tr>
            <th>馬號</th>
            <th>馬名</th>
            <th>騎師</th>
            <th>場地</th>
            <th>路程 (m)</th>
            <th>騎乘次數</th>
            <th>冠</th>
            <th>亞</th>
            <th>季</th>
            <th>第4</th>
            <th>勝出率%</th>
            <th>入Q率%</th>
            <th>入位率%</th>
            <th>入四率%</th>
            <th>得分</th>
            <th>全部計%</th>
            <th>10記綠＝50分</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="17" class="muted">暫未接駁騎師路程統計。</td></tr>
        </tbody>
      </table>
    </div>

    <!-- 6) 練馬師路程統計 -->
    <h3 class="section-title" style="margin-top:.9rem;">
      練馬師路程統計 <span class="pill">練馬師同場地 / 路程表現</span>
    </h3>
    <div class="table-wrap" style="overflow-x:auto;">
      <table class="table" id="trainerDistTable">
        <thead>
          <tr>
            <th>馬號</th>
            <th>馬名</th>
            <th>練馬師</th>
            <th>場地</th>
            <th>路程 (m)</th>
            <th>出馬次數</th>
            <th>冠</th>
            <th>亞</th>
            <th>季</th>
            <th>第4</th>
            <th>勝出率%</th>
            <th>入Q率%</th>
            <th>入位率%</th>
            <th>入四率%</th>
            <th>得分</th>
            <th>全部計%</th>
            <th>10記綠＝50分</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="17" class="muted">暫未接駁練馬師路程統計。</td></tr>
        </tbody>
      </table>
    </div>

    <!-- 7) 人馬合作統計 -->
    <h3 class="section-title" style="margin-top:.9rem;">
      人馬合作統計 <span class="pill">騎師 × 馬匹</span>
    </h3>
    <div class="table-wrap" style="overflow-x:auto;">
      <table class="table" id="horseJockeyTable">
        <thead>
          <tr>
            <th>馬號</th>
            <th>馬名</th>
            <th>騎師</th>
            <th>合作次數</th>
            <th>冠</th>
            <th>亞</th>
            <th>季</th>
            <th>第4</th>
            <th>勝出率%</th>
            <th>入Q率%</th>
            <th>入位率%</th>
            <th>入四率%</th>
            <th>得分</th>
            <th>全部計%</th>
            <th>10記綠＝50分</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="16" class="muted">暫未接駁人馬合作統計。</td></tr>
        </tbody>
      </table>
    </div>

    <!-- 8) 騎練路程統計 -->
    <h3 class="section-title" style="margin-top:.9rem;">
      騎練路程統計 <span class="pill">騎師 × 練馬師 × 場地 / 路程</span>
    </h3>
    <div class="table-wrap" style="overflow-x:auto;">
      <table class="table" id="trainerJockeyDistTable">
        <thead>
          <tr>
            <th>馬號</th>
            <th>馬名</th>
            <th>練馬師</th>
            <th>騎師</th>
            <th>場地</th>
            <th>路程 (m)</th>
            <th>合作次數</th>
            <th>冠</th>
            <th>亞</th>
            <th>季</th>
            <th>第4</th>
            <th>勝出率%</th>
            <th>入Q率%</th>
            <th>入位率%</th>
            <th>入四率%</th>
            <th>得分</th>
            <th>全部計%</th>
            <th>10記綠＝50分</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="18" class="muted">暫未接駁騎練路程統計。</td></tr>
        </tbody>
      </table>
    </div>

    <!-- 9) 綜合評分總覽 -->
    <h3 class="section-title" style="margin-top:.9rem;">
      綜合評分總覽 <span class="pill">所有統計得分 + 總分</span>
    </h3>
    <div class="table-wrap" style="overflow-x:auto;">
      <table class="table" id="summaryTable">
        <thead>
          <tr>
            <th>馬號</th>
            <th>馬名</th>
            <th>馬匹整體分</th>
            <th>負磅分</th>
            <th>檔位整體分</th>
            <th>馬匹檔位分</th>
            <th>馬匹路程分</th>
            <th>騎師路程分</th>
            <th>練馬師路程分</th>
            <th>人馬合作分</th>
            <th>騎練路程分</th>
            <th>總分</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="12" class="muted">載入中…</td>
          </tr>
        </tbody>
      </table>
    </div>

    <p class="muted" style="margin-top:.6rem;font-size:12px;">
      以上統計暫時只建立版面，之後可逐步由後端（如 <code>race_analysis_scores</code>、
      <code>race_combo_scores</code>、<code>horse_histories</code> 等）接駁數據。
    </p>
  </section>

  <!-- 賽果 -->
  <section class="panel" id="panel-results">
    <h3 class="section-title">賽果</h3>
    <div class="table-wrap" style="overflow-x:auto;">
      <table class="table" id="resultsTable">
        <thead>
          <tr>
            <th>名次</th>
            <th>馬號</th>
            <th>馬名</th>
            <th>馬匹編號</th>
            <th>騎師</th>
            <th>練馬師</th>
            <th>檔位</th>
            <th>頭馬距離</th>
            <th>沿途走位</th>
            <th>完成時間</th>
            <th>排位體重</th>
            <th>獨贏賠率</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="12" class="muted">載入中…</td></tr>
        </tbody>
      </table>
    </div>
    <p class="muted" style="margin-top:.4rem;font-size:12px;">
      後端可由 <code>race_results</code> 提供資料：<code>/api/race/results?date=YYYY-MM-DD&amp;venue=ST/HV&amp;race_no=N</code>。
    </p>
  </section>

</main>

<script>
// =========================
// 1. URL 參數
// =========================
const params = new URLSearchParams(window.location.search);
const raceDate = params.get('date') || new Date().toISOString().slice(0,10);
const venue    = params.get('venue') || 'ST';
const raceNo   = Number(params.get('race') || '1');

document.getElementById('title-main').innerHTML =
  `<strong>第 ${raceNo} 場</strong>`;
document.getElementById('title-sub').textContent =
  `${raceDate}・${venue}`;

// =========================
// 2. 全局狀態
// =========================
const state = {
  tab: 'basic',
  raceMeta: null,
  entries: [],
  oddsHistory: {
    WIN: {},
    PLA: {}
  },
  horseStats: [],
  results: [],
  weightStats: [],
  drawComboStats: [],
  horseDistStats: [],
  horseDistMeta: null,
  jockeyDistStats: [],
  trainerDistStats: [],
  trainerJockeyDistStats: [],
  horseJockeyStats: []
};

// =========================
// 3. 返回 / 重新載入
// =========================
document.getElementById('btnBack').onclick = () => {
  if (window.history.length > 1) {
    window.history.back();
  } else {
    const url = new URL(window.location.origin + '/app');
    window.location.href = url.toString();
  }
};

document.getElementById('btnReload').onclick = async () => {
  await reloadAll();
  state.horseStats = [];
  state.results = [];
  state.weightStats = [];
  state.drawComboStats = [];
  state.horseDistStats = [];
  state.jockeyDistStats = [];
  state.trainerDistStats = [];
  state.trainerJockeyDistStats = [];
  state.horseJockeyStats = [];
  renderCurrentTab();
};

// =========================
// 4. Tabs 控制
// =========================
const panels = {
  basic:   document.getElementById('panel-basic'),
  odds:    document.getElementById('panel-odds'),
  runners: document.getElementById('panel-runners'),
  analysis: document.getElementById('panel-analysis'),
  results:  document.getElementById('panel-results')
};

document.getElementById('tabs').addEventListener('click', (e)=>{
  const t = e.target.closest('.tab');
  if (!t) return;
  state.tab = t.dataset.tab;
  renderTabs();
  renderCurrentTab();
});

function renderTabs(){
  [...document.getElementById('tabs').children].forEach(t =>
    t.classList.toggle('active', t.dataset.tab===state.tab)
  );
  Object.keys(panels).forEach(k =>
    panels[k].classList.toggle('active', k===state.tab)
  );
}

// =========================
// 5. 從後端取數據
// =========================
async function loadRaceMeta() {
  const url = `/api/racecard/races?date=${raceDate}&venue=${venue}`;
  console.log('[race] fetch meta:', url);

  const res  = await fetch(url);
  const rows = await res.json();

  const r = rows.find(x => Number(x.race_no) === raceNo) || null;
  state.raceMeta = r;

  if (r) {
    document.getElementById('title-main').innerHTML =
      `<strong>第 ${r.race_no} 場</strong> ${r.race_name_zh || ''}`;
    document.getElementById('title-sub').textContent =
      `${raceDate}・${venue}・${r.course || ''} ${r.distance_m || ''}m・${r.class_text || ''}`;
  }
}

async function loadEntries() {
  const url = `/api/racecard/entries?date=${raceDate}&race_no=${raceNo}`;
  console.log('[race] fetch entries:', url);

  const res  = await fetch(url);
  const rows = await res.json();

  state.entries = Array.isArray(rows) ? rows : [];
}

async function loadOddsHistory(type) {
  const url =
    `/api/odds/history?date=${raceDate}&venue=${venue}&race_no=${raceNo}&type=${type}`;
  console.log('[race] fetch odds history:', type, url);

  const res  = await fetch(url);
  const rows = await res.json();

  const timeKeys = [];
  const byHorse = {};

  for (const r of rows || []) {
    const tsKey = r.snapshot_ts;
    if (!timeKeys.includes(tsKey)) {
      if (timeKeys.length >= 10) continue;
      timeKeys.push(tsKey);
    }
    const no = r.horse_no;
    if (!byHorse[no]) byHorse[no] = {};
    byHorse[no][tsKey] = r.odds;
  }

  state.oddsHistory[type] = {
    times: timeKeys,
    byHorse: byHorse
  };
}

async function loadAllOddsHistory() {
  await Promise.all([
    loadOddsHistory('WIN'),
    loadOddsHistory('PLA')
  ]);
}

// =========================
// 賠率畫面
// =========================
function renderOddsLive() {
  const tbody = document.querySelector('#oddsLiveTable tbody');
  const list  = state.entries || [];

  if (!list.length) {
    tbody.innerHTML =
      `<tr><td colspan="5" class="muted">暫時沒有賠率資料。</td></tr>`;
    return;
  }

  tbody.innerHTML = list.map(e => {
    const win = e.win_odds != null ? Number(e.win_odds).toFixed(2) : '-';
    const pla = e.pla_odds != null ? Number(e.pla_odds).toFixed(2) : '-';
    let ts   = '';
    if (e.last_odds_update) {
      const d = new Date(e.last_odds_update);
      ts = isNaN(d.getTime()) ? String(e.last_odds_update) : d.toLocaleTimeString();
    }

    return `
      <tr>
        <td>${e.horse_no}</td>
        <td>${e.horse_name_zh || ''}</td>
        <td>${win}</td>
        <td>${pla}</td>
        <td class="muted">${ts || '-'}</td>
      </tr>`;
  }).join('');
}

function fmtTime(ts){
  if (!ts) return '';
  const d = new Date(ts);
  if (Number.isNaN(d.getTime())) return ts;
  return d.toLocaleTimeString('zh-HK', { hour12:false });
}

function renderOddsHistoryTable(type, tableId) {
  const tbody = document.querySelector(`#${tableId} tbody`);
  const table = document.getElementById(tableId);
  const entries = state.entries || [];
  const hist    = state.oddsHistory[type] || {};
  const times   = hist.times || [];
  const byHorse = hist.byHorse || {};

  if (!entries.length || !times.length) {
    tbody.innerHTML =
      `<tr><td colspan="12" class="muted">暫時沒有賠率變動。</td></tr>`;
    return;
  }

  const ths = table.querySelectorAll('thead tr th');
  for (let i = 0; i < 10; i++) {
    const tsKey = times[i];
    const label = tsKey ? fmtTime(tsKey) : (i + 1);
    if (ths[2 + i]) ths[2 + i].textContent = label;
  }

  const hotMap = {};
  for (const tsKey of times) {
    let best1 = null;
    let best2 = null;

    for (const e of entries) {
      const no = e.horse_no;
      const v  = byHorse[no] ? byHorse[no][tsKey] : null;
      if (v == null) continue;
      const val = Number(v);
      if (!isFinite(val)) continue;

      if (!best1 || val < best1.odds) {
        best2 = best1;
        best1 = { no, odds: val };
      } else if (!best2 || val < best2.odds) {
        best2 = { no, odds: val };
      }
    }

    hotMap[tsKey] = {
      first:  best1 ? best1.no  : null,
      second: best2 ? best2.no  : null
    };
  }

  tbody.innerHTML = entries.map(e => {
    const no   = e.horse_no;
    const name = e.horse_name_zh || '';

    const cells = times.map(tsKey => {
      const v = byHorse[no] ? byHorse[no][tsKey] : null;
      if (v == null) return `<td class="odds-empty">-</td>`;

      const val = Number(v);
      const tsLabel = fmtTime(tsKey);
      const hotInfo = hotMap[tsKey] || {};
      let cls = 'odds-cell';

      if (hotInfo.first === no) {
        cls += ' odds-cell-hot';
      } else if (hotInfo.second === no) {
        cls += ' odds-cell-warm';
      }

      return `<td class="${cls}" title="${tsLabel}">${val.toFixed(2)}</td>`;
    });

    for (let i = times.length; i < 10; i++) {
      cells.push('<td class="odds-empty">-</td>');
    }

    return `
      <tr>
        <td>${no}</td>
        <td>${name}</td>
        ${cells.join('')}
      </tr>`;
  }).join('');
}

function renderOdds(){
  renderOddsLive();
  renderOddsHistoryTable('WIN', 'oddsHistWIN');
  renderOddsHistoryTable('PLA', 'oddsHistPLA');
}

// =========================
// 7. Basic / Runners
// =========================
function renderBasic(){
  const r = state.raceMeta;
  const box = document.getElementById('basicCards');

  if (!r) {
    box.innerHTML = `
      <div class="card">
        <p class="muted">找不到賽事資料（${raceDate}・${venue}・第 ${raceNo} 場）。</p>
      </div>`;
    return;
  }

  box.innerHTML = `
    <div class="card">
      <h3 style="margin:.2rem 0 .6rem">第 ${r.race_no} 場 ${r.race_name_zh || ''}</h3>
      <div class="kv">
        <div class="muted">賽日</div><div>${raceDate}</div>
        <div class="muted">場地</div><div>${venue}</div>
        <div class="muted">開跑時間</div><div>${(r.race_time || '').slice(0,5)}</div>
        <div class="muted">途程</div><div>${r.course || ''} ${r.distance_m || ''} m</div>
        <div class="muted">班次</div><div>${r.class_text || ''}</div>
        <div class="muted">場地狀況</div><div>${r.going || ''}</div>
        <div class="muted">參賽數</div><div>${state.entries.length}</div>
      </div>
    </div>
    <div class="card">
      <h4 style="margin:.2rem 0 .4rem">備註</h4>
      <p class="muted">（之後可以接駁公告、換騎、退賽等資訊顯示喺呢度。）</p>
    </div>`;
}

function renderRunners() {
  const tbody = document.querySelector('#runnersTable tbody');
  const list  = state.entries;

  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="27" class="muted">暫時沒有馬匹資料。</td></tr>`;
    return;
  }

  tbody.innerHTML = list.map(e => {
    const scratched = Number(e.scratched || 0) === 1;
    return `
      <tr class="${scratched ? 'is-scratched' : ''}">
        <td>${e.horse_no ?? ''}</td>
        <td>${e.horse_name_zh || ''}</td>
        <td>${e.horse_name_en || ''}</td>
        <td>${e.horse_code || ''}</td>
        <td>${e.draw ?? ''}</td>
        <td>${e.jockey_zh || ''}</td>
        <td>${e.trainer_zh || ''}</td>
        <td>${e.rating ?? ''}</td>
        <td>${e.rating_pm || ''}</td>
        <td>${e.weight_lb ?? ''}</td>
        <td>${e.declared_wt ?? ''} ${e.declared_wt_pm || ''}</td>
        <td>${e.age ?? ''}</td>
        <td>${e.sex || ''}</td>
        <td>${e.wfa || ''}</td>
        <td>${e.season_stakes || ''}</td>
        <td>${e.priority || ''}</td>
        <td>${e.days_since || ''}</td>
        <td>${e.owner || ''}</td>
        <td>${e.sire || ''}</td>
        <td>${e.dam || ''}</td>
        <td>${e.import_cat || ''}</td>
        <td>${e.silks || ''}</td>
        <td>${e.brand || ''}</td>
        <td>${e.gear || ''}</td>
        <td>${e.last6 || ''}</td>
        <td>${scratched ? '✅' : ''}</td>
      </tr>`;
  }).join('');
}

// =========================
// 8. 賽事分析
// =========================
function pct(val){
  if (val === null || val === undefined) return '';
  let num = Number(val);
  if (!Number.isFinite(num)) return '';
  if (num >= 0 && num <= 1) num = num * 100;
  return num.toFixed(1);
}

function fmtScore(val, digits = 3){
  if (val === null || val === undefined) return '';
  const num = Number(val);
  if (!Number.isFinite(num)) return '';
  return num.toFixed(digits);
}

async function renderAnalysis(){
  const tbodyHorse      = document.querySelector('#analysisTable tbody');
  const tbodyDraw       = document.querySelector('#drawTable tbody');
  const tbodyWeight     = document.querySelector('#weightTable tbody');
  const tbodyHorseDraw  = document.querySelector('#horseDrawTable tbody');
  const tbodyHorseDist  = document.querySelector('#horseDistTable tbody');
  const tbodyJockeyDist = document.querySelector('#jockeyDistTable tbody');
  const tbodyTrainerDist = document.querySelector('#trainerDistTable tbody');
  const tbodyHorseJockey = document.querySelector('#horseJockeyTable tbody');
  const tbodyTrainerJockeyDist = document.querySelector('#trainerJockeyDistTable tbody');
  const tbodySummary = document.querySelector('#summaryTable tbody');

  // 第一次入 tab 先 set loading
  if (!state.horseStats || !state.horseStats.length){
    tbodyHorse.innerHTML       = `<tr><td colspan="14" class="muted">載入中…</td></tr>`;
    tbodyDraw.innerHTML        = `<tr><td colspan="15" class="muted">載入中…</td></tr>`;
    tbodyWeight.innerHTML      = `<tr><td colspan="15" class="muted">載入中…</td></tr>`;
    tbodyHorseDraw.innerHTML   = `<tr><td colspan="15" class="muted">載入中…</td></tr>`;
    tbodyHorseDist.innerHTML   = `<tr><td colspan="16" class="muted">載入中…</td></tr>`;
    tbodyJockeyDist.innerHTML  = `<tr><td colspan="17" class="muted">載入中…</td></tr>`;
    tbodyTrainerDist.innerHTML = `<tr><td colspan="17" class="muted">載入中…</td></tr>`;
    tbodyHorseJockey.innerHTML = `<tr><td colspan="16" class="muted">載入中…</td></tr>`;
    tbodyTrainerJockeyDist.innerHTML = `<tr><td colspan="18" class="muted">載入中…</td></tr>`;
    tbodySummary.innerHTML     = `<tr><td colspan="12" class="muted">載入中…</td></tr>`;

    try{
      const url = `/api/race/horse_stats?date=${raceDate}&venue=${venue}&race_no=${raceNo}`;
      console.log('[race] fetch horse_stats:', url);
      const res  = await fetch(url);
      const rows = await res.json();
      console.log('[race] horse_stats sample:', rows[0]);
      state.horseStats = Array.isArray(rows) ? rows : [];
    }catch(e){
      console.error('[race] horse_stats error', e);
      tbodyHorse.innerHTML      = `<tr><td colspan="14" class="muted">暫時未能載入馬匹統計。</td></tr>`;
      tbodyDraw.innerHTML       = `<tr><td colspan="15" class="muted">暫時未能載入檔位統計。</td></tr>`;
      tbodyWeight.innerHTML     = `<tr><td colspan="15" class="muted">暫時未能載入負磅統計。</td></tr>`;
      tbodyHorseDraw.innerHTML  = `<tr><td colspan="15" class="muted">暫時未能載入馬匹檔位統計。</td></tr>`;
      tbodyHorseDist.innerHTML  = `<tr><td colspan="16" class="muted">暫時未能載入馬匹路程統計。</td></tr>`;
      tbodyJockeyDist.innerHTML = `<tr><td colspan="17" class="muted">暫時未能載入騎師路程統計。</td></tr>`;
      tbodyTrainerDist.innerHTML = `<tr><td colspan="17" class="muted">暫時未能載入練馬師路程統計。</td></tr>`;
      tbodyHorseJockey.innerHTML = `<tr><td colspan="16" class="muted">暫時未能載入人馬合作統計。</td></tr>`;
      tbodySummary.innerHTML     = `<tr><td colspan="12" class="muted">暫時未能載入綜合評分。</td></tr>`;
      return;
    }
  }

  const list = state.horseStats;
  if (!list.length){
    tbodyHorse.innerHTML      = `<tr><td colspan="14" class="muted">暫時沒有統計資料。</td></tr>`;
    tbodyDraw.innerHTML       = `<tr><td colspan="15" class="muted">暫時沒有統計資料。</td></tr>`;
    tbodyWeight.innerHTML     = `<tr><td colspan="15" class="muted">暫時沒有統計資料。</td></tr>`;
    tbodyHorseDraw.innerHTML  = `<tr><td colspan="15" class="muted">暫時沒有統計資料。</td></tr>`;
    tbodyHorseDist.innerHTML  = `<tr><td colspan="16" class="muted">暫時沒有統計資料。</td></tr>`;
    tbodyJockeyDist.innerHTML = `<tr><td colspan="17" class="muted">暫時沒有統計資料。</td></tr>`;
    tbodyTrainerDist.innerHTML = `<tr><td colspan="17" class="muted">暫時沒有統計資料。</td></tr>`;
    tbodyHorseJockey.innerHTML = `<tr><td colspan="16" class="muted">暫時沒有統計資料。</td></tr>`;
    tbodySummary.innerHTML     = `<tr><td colspan="12" class="muted">暫時沒有統計資料。</td></tr>`;
    return;
  }

  const entryByHorseNo = {};
  (state.entries || []).forEach(e => {
    entryByHorseNo[String(e.horse_no)] = e;
  });

  list.sort((a,b)=> Number(a.horse_no||0) - Number(b.horse_no||0));

  // 2) 馬匹整體統計
  tbodyHorse.innerHTML = list.map(r => {
    const starts = r.starts ?? r.horse_runs ?? r.total_runs ?? '';
    const win    = r.win ?? r.win_cnt ?? 0;
    const second = r.second ?? r.second_place ?? r.place2_cnt ?? 0;
    const third  = r.third ?? r.place3_cnt ?? 0;
    const fourth = r.fourth ?? r.place4_cnt ?? 0;

    const winPct   = r.win_pct   ?? r.horse_win_rate   ?? r.win_rate;
    const qPct     = r.q_pct     ?? r.horse_q_rate     ?? r.q_rate;
    const placePct = r.place_pct ?? r.horse_place_rate ?? r.plc_rate;
    const top4Pct  = r.top4_pct  ?? r.horse_top4_rate  ?? r.top4_rate;

    const score    = r.score     ?? r.horse_score_raw;
    const totalPct = r.total_pct ?? r.horse_score_norm;
    const green10  = r.green10   ?? r.horse_score_final;

    return `
      <tr>
        <td>${r.horse_no ?? ''}</td>
        <td>${r.horse_name_zh || ''}</td>
        <td>${starts}</td>
        <td>${win}</td>
        <td>${second}</td>
        <td>${third}</td>
        <td>${fourth}</td>
        <td>${winPct   != null ? pct(winPct)   : ''}</td>
        <td>${qPct     != null ? pct(qPct)     : ''}</td>
        <td>${placePct != null ? pct(placePct) : ''}</td>
        <td>${top4Pct  != null ? pct(top4Pct)  : ''}</td>
        <td>${score    != null ? Number(score).toFixed(1)    : ''}</td>
        <td>${totalPct != null ? Number(totalPct).toFixed(1) : ''}</td>
        <td>${green10  != null ? Number(green10).toFixed(1)  : ''}</td>
      </tr>
    `;
  }).join('');

  // 3) 檔位統計
  tbodyDraw.innerHTML = list.map(r => {
    const horseNoKey = String(r.horse_no ?? '');
    const entry      = entryByHorseNo[horseNoKey] || {};
    const gate       = entry.draw ?? r.gate_no ?? r.draw ?? r.draw_no ?? '';

    const runs = r.draw_runs ?? 0;
    const win  = r.draw_win ?? 0;
    const p2   = r.draw_second_place ?? 0;
    const p3   = r.draw_third_place ?? 0;
    const p4   = r.draw_forth_place ?? 0;

    const winPct   = r.draw_win_pct   ?? r.draw_win_rate;
    const qPct     = r.draw_q_pct     ?? r.draw_q_rate;
    const placePct = r.draw_place_pct ?? r.draw_place_rate;
    const top4Pct  = r.draw_top4_pct  ?? r.draw_top4_rate;

    const score    = r.draw_score     ?? r.draw_score_raw;
    const totalPct = r.draw_total_pct ?? r.draw_score_norm;
    const green10  = r.draw_green10   ?? r.draw_score_final;

    return `
      <tr>
        <td>${r.horse_no ?? ''}</td>
        <td>${r.horse_name_zh || ''}</td>
        <td>${gate}</td>
        <td>${runs}</td>
        <td>${win}</td>
        <td>${p2}</td>
        <td>${p3}</td>
        <td>${p4}</td>
        <td>${winPct   != null ? pct(winPct)   : ''}</td>
        <td>${qPct     != null ? pct(qPct)     : ''}</td>
        <td>${placePct != null ? pct(placePct) : ''}</td>
        <td>${top4Pct  != null ? pct(top4Pct)  : ''}</td>
        <td>${score    != null ? Number(score).toFixed(1)    : ''}</td>
        <td>${totalPct != null ? Number(totalPct).toFixed(1) : ''}</td>
        <td>${green10  != null ? Number(green10).toFixed(1)  : ''}</td>
      </tr>
    `;
  }).join('');

  // 4) 負磅統計
  if (!state.weightStats || !state.weightStats.length) {
    try {
      const urlW = `/api/race/weight_stats?date=${raceDate}&venue=${venue}&race_no=${raceNo}`;
      console.log('[race] fetch weight_stats:', urlW);
      const resW  = await fetch(urlW);
      const rowsW = await resW.json();
      state.weightStats = Array.isArray(rowsW) ? rowsW : [];
    } catch (e) {
      console.error('[race] weight_stats error', e);
      tbodyWeight.innerHTML = `<tr><td colspan="15" class="muted">暫時未能載入負磅統計。</td></tr>`;
    }
  }

  const wList = state.weightStats || [];
  if (!wList.length) {
    tbodyWeight.innerHTML = `<tr><td colspan="15" class="muted">暫時沒有負磅統計資料。</td></tr>`;
  } else {
    wList.sort((a,b)=>{
      const ha = Number(a.horse_no||0) - Number(b.horse_no||0);
      if (ha !== 0) return ha;
      return String(a.weight_zone||'').localeCompare(String(b.weight_zone||''));
    });

    tbodyWeight.innerHTML = wList.map(r => `
      <tr>
        <td>${r.horse_no ?? ''}</td>
        <td>${r.horse_name_zh || ''}</td>
        <td>${r.weight_zone || ''}</td>
        <td>${r.runs ?? ''}</td>
        <td>${r.win_cnt ?? ''}</td>
        <td>${r.second_cnt ?? ''}</td>
        <td>${r.third_cnt ?? ''}</td>
        <td>${r.fourth_cnt ?? ''}</td>
        <td>${pct(r.win_pct)}</td>
        <td>${pct(r.q_pct)}</td>
        <td>${pct(r.place_pct)}</td>
        <td>${pct(r.top4_pct)}</td>
        <td>${fmtScore(r.score_raw)}</td>
        <td>${fmtScore(r.score_norm)}</td>
        <td>${fmtScore(r.score_final)}</td>
      </tr>
    `).join('');
  }

  // 5) 馬匹檔位統計
  if (!state.drawComboStats || !state.drawComboStats.length) {
    try {
      const urlD = `/api/race/draw_stats?date=${raceDate}&venue=${venue}&race_no=${raceNo}`;
      console.log('[race] fetch draw_stats:', urlD);
      const resD  = await fetch(urlD);
      const rowsD = await resD.json();
      state.drawComboStats = Array.isArray(rowsD) ? rowsD : [];
    } catch (e) {
      console.error('[race] draw_stats error', e);
      tbodyHorseDraw.innerHTML = `<tr><td colspan="15" class="muted">暫時未能載入馬匹檔位統計。</td></tr>`;
    }
  }

  const dList = state.drawComboStats || [];
  if (!dList.length) {
    tbodyHorseDraw.innerHTML = `<tr><td colspan="15" class="muted">暫時沒有馬匹檔位統計資料。</td></tr>`;
  } else {
    dList.sort((a,b)=> Number(a.horse_no||0) - Number(b.horse_no||0));

    tbodyHorseDraw.innerHTML = dList.map(r => {
      let drawBandText = '';
      if (r.draw_band === 'HORSE_DRAW_1_4')       drawBandText = '1–4 檔';
      else if (r.draw_band === 'HORSE_DRAW_5_8')  drawBandText = '5–8 檔';
      else if (r.draw_band === 'HORSE_DRAW_9_14') drawBandText = '9–14 檔';
      else drawBandText = r.draw_band || '';

      return `
        <tr>
          <td>${r.horse_no ?? ''}</td>
          <td>${r.horse_name_zh || ''}</td>
          <td>${drawBandText}</td>
          <td>${r.runs ?? ''}</td>
          <td>${r.win_cnt ?? ''}</td>
          <td>${r.second_cnt ?? ''}</td>
          <td>${r.third_cnt ?? ''}</td>
          <td>${r.fourth_cnt ?? ''}</td>
          <td>${pct(r.win_pct)}</td>
          <td>${pct(r.q_pct)}</td>
          <td>${pct(r.place_pct)}</td>
          <td>${pct(r.top4_pct)}</td>
          <td>${fmtScore(r.score_raw)}</td>
          <td>${fmtScore(r.score_norm)}</td>
          <td>${fmtScore(r.score_final)}</td>
        </tr>
      `;
    }).join('');
  }

  // 6) 馬匹路程統計
  if (!state.horseDistStats || !state.horseDistStats.length) {
    try {
      const urlDist = `/api/race/distance_stats?date=${raceDate}&venue=${venue}&race_no=${raceNo}`;
      console.log('[race] fetch distance_stats:', urlDist);
      const resDist  = await fetch(urlDist);
      const dataDist = await resDist.json();

      state.horseDistStats = Array.isArray(dataDist.items) ? dataDist.items : [];
      state.horseDistMeta  = {
        distance_m: dataDist.distance_m,
        metric_code: dataDist.metric_code
      };
    } catch (e) {
      console.error('[race] distance_stats error', e);
      tbodyHorseDist.innerHTML = `<tr><td colspan="16" class="muted">暫時未能載入馬匹路程統計。</td></tr>`;
    }
  }

  const distList = state.horseDistStats || [];
  if (!distList.length) {
    tbodyHorseDist.innerHTML = `<tr><td colspan="16" class="muted">暫時沒有馬匹路程統計資料。</td></tr>`;
  } else {
    const distMeta = state.horseDistMeta || {};
    const distM    = distMeta.distance_m || (state.raceMeta ? state.raceMeta.distance_m : '');

    distList.sort((a,b)=> Number(a.horse_no||0) - Number(b.horse_no||0));

    tbodyHorseDist.innerHTML = distList.map(r => `
      <tr>
        <td>${r.horse_no ?? ''}</td>
        <td>${r.horse_name_zh || ''}</td>
        <td>${venue}</td>
        <td>${distM ?? ''}</td>
        <td>${r.runs ?? ''}</td>
        <td>${r.win_cnt ?? ''}</td>
        <td>${r.second_cnt ?? ''}</td>
        <td>${r.third_cnt ?? ''}</td>
        <td>${r.fourth_cnt ?? ''}</td>
        <td>${pct(r.win_pct)}</td>
        <td>${pct(r.q_pct)}</td>
        <td>${pct(r.place_pct)}</td>
        <td>${pct(r.top4_pct)}</td>
        <td>${fmtScore(r.score_raw)}</td>
        <td>${fmtScore(r.score_norm)}</td>
        <td>${fmtScore(r.score_final)}</td>
      </tr>
    `).join('');
  }

  // 7) 騎師路程統計
  if (!state.jockeyDistStats || !state.jockeyDistStats.length) {
    try {
      const urlJ = `/api/race/jockey_dist_stats?date=${raceDate}&venue=${venue}&race_no=${raceNo}`;
      console.log('[race] fetch jockey_dist_stats:', urlJ);
      const resJ  = await fetch(urlJ);
      const rowsJ = await resJ.json();
      state.jockeyDistStats = Array.isArray(rowsJ) ? rowsJ : [];
    } catch (e) {
      console.error('[race] jockey_dist_stats error', e);
      tbodyJockeyDist.innerHTML = `<tr><td colspan="17" class="muted">暫時未能載入騎師路程統計。</td></tr>`;
    }
  }

  const jList = state.jockeyDistStats || [];
  if (!jList.length) {
    tbodyJockeyDist.innerHTML =
      `<tr><td colspan="17" class="muted">暫時沒有騎師路程統計資料。</td></tr>`;
  } else {
    jList.sort((a, b) => {
      const ha = (Number(a.horse_no || 0) - Number(b.horse_no || 0));
      if (ha !== 0) return ha;
      return (a.jockey_zh || '').localeCompare(b.jockey_zh || '');
    });

    tbodyJockeyDist.innerHTML = jList.map(r => `
      <tr>
        <td>${r.horse_no ?? ''}</td>
        <td>${r.horse_name_zh || ''}</td>
        <td>${r.jockey_zh || ''}</td>
        <td>${r.venue || ''}</td>
        <td>${r.distance_m ?? ''}</td>
        <td>${r.runs ?? ''}</td>
        <td>${r.win_cnt ?? ''}</td>
        <td>${r.second_cnt ?? ''}</td>
        <td>${r.third_cnt ?? ''}</td>
        <td>${r.fourth_cnt ?? ''}</td>
        <td>${pct(r.win_pct)}</td>
        <td>${pct(r.q_pct)}</td>
        <td>${pct(r.place_pct)}</td>
        <td>${pct(r.top4_pct)}</td>
        <td>${fmtScore(r.score_raw)}</td>
        <td>${fmtScore(r.score_norm)}</td>
        <td>${fmtScore(r.score_final)}</td>
      </tr>
    `).join('');
  }

  // 8) 人馬合作統計
  if (!state.horseJockeyStats || !state.horseJockeyStats.length) {
    try {
      const urlHJ = `/api/race/horse_jockey_stats?date=${raceDate}&venue=${venue}&race_no=${raceNo}`;
      console.log('[race] fetch horse_jockey_stats:', urlHJ);
      const resHJ  = await fetch(urlHJ);
      const rowsHJ = await resHJ.json();
      state.horseJockeyStats = Array.isArray(rowsHJ) ? rowsHJ : [];
    } catch (e) {
      console.error('[race] horse_jockey_stats error', e);
      tbodyHorseJockey.innerHTML =
        `<tr><td colspan="16" class="muted">暫時未能載入人馬合作統計。</td></tr>`;
    }
  }

  const hjList = state.horseJockeyStats || [];
  if (!hjList.length) {
    tbodyHorseJockey.innerHTML =
      `<tr><td colspan="16" class="muted">暫時沒有人馬合作統計資料。</td></tr>`;
  } else {
    hjList.sort((a, b) => {
      const ha = (Number(a.horse_no || 0) - Number(b.horse_no || 0));
      if (ha !== 0) return ha;
      return (a.jockey_zh || '').localeCompare(b.jockey_zh || '');
    });

    tbodyHorseJockey.innerHTML = hjList.map(r => `
      <tr>
        <td>${r.horse_no ?? ''}</td>
        <td>${r.horse_name_zh || ''}</td>
        <td>${r.jockey_zh || ''}</td>
        <td>${r.runs ?? ''}</td>
        <td>${r.win_cnt ?? ''}</td>
        <td>${r.second_cnt ?? ''}</td>
        <td>${r.third_cnt ?? ''}</td>
        <td>${r.fourth_cnt ?? ''}</td>
        <td>${pct(r.win_pct)}</td>
        <td>${pct(r.q_pct)}</td>
        <td>${pct(r.place_pct)}</td>
        <td>${pct(r.top4_pct)}</td>
        <td>${fmtScore(r.score_raw)}</td>
        <td>${fmtScore(r.score_norm)}</td>
        <td>${fmtScore(r.score_final)}</td>
      </tr>
    `).join('');
  }

  // 9) 練馬師路程統計
  if (!state.trainerDistStats || !state.trainerDistStats.length) {
    try {
      const urlT = `/api/race/trainer_dist_stats?date=${raceDate}&venue=${venue}&race_no=${raceNo}`;
      console.log('[race] fetch trainer_dist_stats:', urlT);
      const resT  = await fetch(urlT);
      const rowsT = await resT.json();
      state.trainerDistStats = Array.isArray(rowsT) ? rowsT : [];
    } catch (e) {
      console.error('[race] trainer_dist_stats error', e);
      tbodyTrainerDist.innerHTML =
        `<tr><td colspan="17" class="muted">暫時未能載入練馬師路程統計。</td></tr>`;
    }
  }

  const tList = state.trainerDistStats || [];
  if (!tList.length) {
    tbodyTrainerDist.innerHTML =
      `<tr><td colspan="17" class="muted">暫時沒有練馬師路程統計資料。</td></tr>`;
  } else {
    tList.sort((a, b) => {
      const ha = (Number(a.horse_no || 0) - Number(b.horse_no || 0));
      if (ha !== 0) return ha;
      return (a.trainer_zh || '').localeCompare(b.trainer_zh || '');
    });

    tbodyTrainerDist.innerHTML = tList.map(r => `
      <tr>
        <td>${r.horse_no ?? ''}</td>
        <td>${r.horse_name_zh || ''}</td>
        <td>${r.trainer_zh || ''}</td>
        <td>${r.venue || ''}</td>
        <td>${r.distance_m ?? ''}</td>
        <td>${r.runs ?? ''}</td>
        <td>${r.win_cnt ?? ''}</td>
        <td>${r.second_cnt ?? ''}</td>
        <td>${r.third_cnt ?? ''}</td>
        <td>${r.fourth_cnt ?? ''}</td>
        <td>${pct(r.win_pct)}</td>
        <td>${pct(r.q_pct)}</td>
        <td>${pct(r.place_pct)}</td>
        <td>${pct(r.top4_pct)}</td>
        <td>${fmtScore(r.score_raw)}</td>
        <td>${fmtScore(r.score_norm)}</td>
        <td>${fmtScore(r.score_final)}</td>
      </tr>
    `).join('');
  }

  // 10) 騎練路程統計
  if (!state.trainerJockeyDistStats || !state.trainerJockeyDistStats.length) {
    try {
      const urlTJ = `/api/race/trainer_jockey_dist_stats?date=${raceDate}&venue=${venue}&race_no=${raceNo}`;
      console.log('[race] fetch trainer_jockey_dist_stats:', urlTJ);
      const resTJ  = await fetch(urlTJ);
      const rowsTJ = await resTJ.json();
      state.trainerJockeyDistStats = Array.isArray(rowsTJ) ? rowsTJ : [];
    } catch (e) {
      console.error('[race] trainer_jockey_dist_stats error', e);
      tbodyTrainerJockeyDist.innerHTML =
        `<tr><td colspan="18" class="muted">暫時未能載入騎練路程統計。</td></tr>`;
    }
  }

  const tjList = state.trainerJockeyDistStats || [];
  if (!tjList.length) {
    tbodyTrainerJockeyDist.innerHTML =
      `<tr><td colspan="18" class="muted">暫時沒有騎練路程統計資料。</td></tr>`;
  } else {
    tjList.sort((a, b) => {
      const ha = (Number(a.horse_no || 0) - Number(b.horse_no || 0));
      if (ha !== 0) return ha;
      const ta = (a.trainer_zh || '').localeCompare(b.trainer_zh || '');
      if (ta !== 0) return ta;
      return (a.jockey_zh || '').localeCompare(b.jockey_zh || '');
    });

    tbodyTrainerJockeyDist.innerHTML = tjList.map(r => `
      <tr>
        <td>${r.horse_no ?? ''}</td>
        <td>${r.horse_name_zh || ''}</td>
        <td>${r.trainer_zh || ''}</td>
        <td>${r.jockey_zh || ''}</td>
        <td>${r.venue || ''}</td>
        <td>${r.distance_m ?? ''}</td>
        <td>${r.runs ?? ''}</td>
        <td>${r.win_cnt ?? ''}</td>
        <td>${r.second_cnt ?? ''}</td>
        <td>${r.third_cnt ?? ''}</td>
        <td>${r.fourth_cnt ?? ''}</td>
        <td>${pct(r.win_pct)}</td>
        <td>${pct(r.q_pct)}</td>
        <td>${pct(r.place_pct)}</td>
        <td>${pct(r.top4_pct)}</td>
        <td>${fmtScore(r.score_raw)}</td>
        <td>${fmtScore(r.score_norm)}</td>
        <td>${fmtScore(r.score_final)}</td>
      </tr>
    `).join('');
  }

  // 11) 綜合評分總覽（全部以 score / score_raw 為主）
  const scoreMap = new Map();

  function addScore(horseNo, horseName, key, val){
    if (horseNo === null || horseNo === undefined) return;
    if (val === null || val === undefined) return;
    const num = Number(val);
    if (!Number.isFinite(num)) return;

    const k = String(horseNo);
    let obj = scoreMap.get(k);
    if (!obj) {
      obj = {
        horse_no: horseNo,
        horse_name_zh: horseName || '',
        horseScore: null,
        weightScore: null,
        drawScore: null,
        horseDrawScore: null,
        horseDistScore: null,
        jockeyDistScore: null,
        trainerDistScore: null,
        horseJockeyScore: null,
        trainerJockeyScore: null
      };
      scoreMap.set(k, obj);
    }
    if (obj[key] === null || obj[key] === undefined || num > obj[key]) {
      obj[key] = num;
    }
  }

  // 11.1 馬匹整體分 / 檔位整體分
  list.forEach(r => {
    const no   = r.horse_no;
    const name = r.horse_name_zh || '';

    const horseScore =
      (r.score != null ? r.score :
       (r.horse_score_raw != null ? r.horse_score_raw :
        (r.green10 != null ? r.green10 :
         (r.horse_score_final != null ? r.horse_score_final : null))));

    const drawScore =
      (r.draw_score_raw != null ? r.draw_score_raw :
       (r.draw_score != null ? r.draw_score :
        (r.draw_green10 != null ? r.draw_green10 :
         (r.draw_score_final != null ? r.draw_score_final : null))));

    addScore(no, name, 'horseScore', horseScore);
    addScore(no, name, 'drawScore',  drawScore);
  });

  // 11.2 負磅分
  (state.weightStats || []).forEach(r => {
    const s = (r.score_raw != null ? r.score_raw :
              (r.score != null ? r.score : r.score_final));
    addScore(r.horse_no, r.horse_name_zh, 'weightScore', s);
  });

  // 11.3 馬匹檔位分
  (state.drawComboStats || []).forEach(r => {
    const s = (r.score_raw != null ? r.score_raw :
              (r.score != null ? r.score : r.score_final));
    addScore(r.horse_no, r.horse_name_zh, 'horseDrawScore', s);
  });

  // 11.4 馬匹路程分
  (state.horseDistStats || []).forEach(r => {
    const s = (r.score_raw != null ? r.score_raw :
              (r.score != null ? r.score : r.score_final));
    addScore(r.horse_no, r.horse_name_zh, 'horseDistScore', s);
  });

  // 11.5 騎師路程分
  (state.jockeyDistStats || []).forEach(r => {
    const s = (r.score_raw != null ? r.score_raw :
              (r.score != null ? r.score : r.score_final));
    addScore(r.horse_no, r.horse_name_zh, 'jockeyDistScore', s);
  });

  // 11.6 練馬師路程分
  (state.trainerDistStats || []).forEach(r => {
    const s = (r.score_raw != null ? r.score_raw :
              (r.score != null ? r.score : r.score_final));
    addScore(r.horse_no, r.horse_name_zh, 'trainerDistScore', s);
  });

  // 11.7 人馬合作分
  (state.horseJockeyStats || []).forEach(r => {
    const s = (r.score_raw != null ? r.score_raw :
              (r.score != null ? r.score : r.score_final));
    addScore(r.horse_no, r.horse_name_zh, 'horseJockeyScore', s);
  });

  // 11.8 騎練路程分
  (state.trainerJockeyDistStats || []).forEach(r => {
    const s = (r.score_raw != null ? r.score_raw :
              (r.score != null ? r.score : r.score_final));
    addScore(r.horse_no, r.horse_name_zh, 'trainerJockeyScore', s);
  });

  const summaryList = Array.from(scoreMap.values())
    .sort((a,b)=> Number(a.horse_no||0) - Number(b.horse_no||0));

  if (!summaryList.length){
    tbodySummary.innerHTML =
      `<tr><td colspan="12" class="muted">暫時沒有綜合評分資料。</td></tr>`;
  } else {
    tbodySummary.innerHTML = summaryList.map(r => {
      const total = [
        r.horseScore,
        r.weightScore,
        r.drawScore,
        r.horseDrawScore,
        r.horseDistScore,
        r.jockeyDistScore,
        r.trainerDistScore,
        r.horseJockeyScore,
        r.trainerJockeyScore
      ].reduce((sum, x) => {
        const n = Number(x);
        return Number.isFinite(n) ? sum + n : sum;
      }, 0);

      return `
        <tr>
          <td>${r.horse_no ?? ''}</td>
          <td>${r.horse_name_zh || ''}</td>
          <td>${fmtScore(r.horseScore)}</td>
          <td>${fmtScore(r.weightScore)}</td>
          <td>${fmtScore(r.drawScore)}</td>
          <td>${fmtScore(r.horseDrawScore)}</td>
          <td>${fmtScore(r.horseDistScore)}</td>
          <td>${fmtScore(r.jockeyDistScore)}</td>
          <td>${fmtScore(r.trainerDistScore)}</td>
          <td>${fmtScore(r.horseJockeyScore)}</td>
          <td>${fmtScore(r.trainerJockeyScore)}</td>
          <td>${fmtScore(total)}</td>
        </tr>
      `;
    }).join('');
  }
}

// =========================
// 9. 賽果
// =========================
async function renderResults(){
  const tbody = document.querySelector('#resultsTable tbody');

  if (!state.results || !state.results.length){
    tbody.innerHTML = `<tr><td colspan="12" class="muted">載入中…</td></tr>`;
    try{
      const url = `/api/race/results?date=${raceDate}&venue=${venue}&race_no=${raceNo}`;
      console.log('[race] fetch results:', url);
      const res  = await fetch(url);
      const rows = await res.json();
      state.results = Array.isArray(rows) ? rows : [];
    }catch(e){
      console.error('[race] results error', e);
      tbody.innerHTML = `<tr><td colspan="12" class="muted">暫時未能載入賽果。</td></tr>`;
      return;
    }
  }

  const list = state.results;
  if (!list.length){
    tbody.innerHTML = `<tr><td colspan="12" class="muted">暫時沒有賽果資料。</td></tr>`;
    return;
  }

  tbody.innerHTML = list.map(r => `
    <tr>
      <td>${r.placing ?? ''}</td>
      <td>${r.horse_no ?? ''}</td>
      <td>${r.horse_name_zh || ''}</td>
      <td>${r.horse_id || ''}</td>
      <td>${r.jockey_zh || ''}</td>
      <td>${r.trainer_zh || ''}</td>
      <td>${r.draw_no ?? ''}</td>
      <td>${r.lbw || ''}</td>
      <td>${r.running_pos || ''}</td>
      <td>${r.finish_time || ''}</td>
      <td>${r.declared_weight || ''}</td>
      <td>${r.win_odds || ''}</td>
    </tr>
  `).join('');
}

// =========================
// 10. 切 tab 時 render
// =========================
function renderCurrentTab(){
  if (state.tab === 'basic')   renderBasic();
  if (state.tab === 'odds')    renderOdds();
  if (state.tab === 'runners') renderRunners();
  if (state.tab === 'analysis') renderAnalysis();
  if (state.tab === 'results')  renderResults();
}

// =========================
// 11. 自動更新（賠率）
// =========================
let autoTimer = setInterval(async () => {
  try {
    await Promise.all([
      loadEntries(),
      loadAllOddsHistory()
    ]);
    if (state.tab === 'odds') {
      renderOdds();
    }
  } catch (e) {
    console.error('[auto-refresh] error', e);
  }
}, 10 * 1000);

// =========================
// 12. 初始化
// =========================
renderTabs();
async function reloadAll() {
  try {
    await Promise.all([
      loadRaceMeta(),
      loadEntries(),
      loadAllOddsHistory()
    ]);
  } catch (err) {
    console.error('[race] reload error', err);
  }
}
reloadAll().then(() => {
  renderCurrentTab();
}).catch(err => {
  console.error(err);
  renderCurrentTab();
});
</script>

</body>
</html>
