<!doctype html>
<html lang="zh-HK">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>賽事詳情 - HKJC 面板</title>
<style>
  :root{
    --bg: #0f1115;
    --panel: #171a21;
    --muted: #9aa4b2;
    --text: #e6ebf2;
    --primary: #4da3ff;
    --accent: #7ee081;
    --danger: #ff6b6b;
    --border: #2a2f3a;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg: #f6f7fb; --panel:#fff; --muted:#5e6a77; --text:#1b2430;
      --primary:#1864ff; --accent:#129b45; --danger:#c42525; --border:#e7eaf0;
    }
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto}

  .appbar{position:sticky;top:0;z-index:40;background:var(--panel);border-bottom:1px solid var(--border)}
  .appbar .row{display:flex;align-items:center;gap:.75rem;padding:.6rem 1rem}
  .btn{border:1px solid var(--border);background:transparent;color:var(--text);padding:.4rem .7rem;border-radius:.55rem;cursor:pointer}
  .btn.primary{background:var(--primary);border-color:transparent;color:#fff}
  .muted{color:var(--muted)}

  main{padding:1rem}
  .tabs{display:flex;gap:.25rem;border-bottom:1px solid var(--border);padding:.2rem}
  .tab{padding:.55rem .9rem;border-radius:.55rem;cursor:pointer;color:var(--muted)}
  .tab.active{background:rgba(77,163,255,.15);color:var(--text)}
  .panel{display:none;padding:1rem 0}
  .panel.active{display:block}

  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:.8rem}
  .card{border:1px solid var(--border);border-radius:.65rem;padding:.9rem;background:var(--panel)}
  .kv{display:grid;grid-template-columns:120px 1fr;gap:.35rem .6rem}
  .kv div{padding:.15rem 0;border-bottom:1px dashed var(--border)}

  .table-wrap{background:var(--panel);border:1px solid var(--border);border-radius:.8rem;overflow:hidden}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding:.4rem .6rem;border-bottom:1px solid rgba(255,255,255,.03)}
  .table th{color:var(--muted);font-weight:600;font-size:12px}
  .table tr:nth-child(even){background:rgba(255,255,255,0.02)}

  .section-title{margin:.3rem 0 .4rem;font-size:15px;font-weight:600}
  .pill{display:inline-flex;align-items:center;padding:0 .5rem;border-radius:999px;background:rgba(77,163,255,.18);color:var(--primary);font-size:11px;margin-left:.4rem}

  @media (max-width:600px){
    .kv{grid-template-columns:1fr}
    .table-wrap{overflow-x:auto}
  }
</style>
</head>
<body>
<div class="appbar">
  <div class="row">
    <button class="btn" id="btnBack">← 返回賽日</button>
    <div>
      <div id="title-main"><strong>賽事詳情</strong></div>
      <div class="muted" id="title-sub"></div>
    </div>
    <div style="flex:1"></div>
    <button class="btn primary" id="btnReload">重新載入</button>
  </div>
</div>

<main>
  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="basic">基本資料</div>
    <div class="tab" data-tab="odds">賠率 / 投注池</div>
    <div class="tab" data-tab="runners">馬匹名單</div>
  </div>

  <section class="panel active" id="panel-basic">
    <div class="cards" id="basicCards"></div>
  </section>

  <!-- 賠率 panel：上面最新賠率，下面最近 10 筆 snapshot -->
  <section class="panel" id="panel-odds">
    <h3 class="section-title">
      最新賠率<span class="pill" id="oddsSummaryPill">載入中…</span>
    </h3>
    <div class="table-wrap">
      <table class="table" id="oddsTable">
        <thead>
          <tr>
            <th>馬號</th>
            <th>馬名</th>
            <th>獨贏</th>
            <th>位置</th>
            <th>最後更新</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h3 class="section-title" style="margin-top:1.1rem;">
      最近 10 筆賠率變動
    </h3>
    <div class="table-wrap">
      <table class="table" id="oddsSnapshotsTable">
        <thead>
          <tr>
            <th>時間</th>
            <th>馬號</th>
            <th>馬名</th>
            <th>投注類別</th>
            <th>賠率</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="panel" id="panel-runners">
    <div class="table-wrap" style="overflow-x:auto;">
      <table class="table" id="runnersTable">
        <thead>
          <tr>
            <th>馬號</th>
            <th>馬名（中）</th>
            <th>馬名（英）</th>
            <th>馬匹編號</th>
            <th>檔位</th>
            <th>騎師</th>
            <th>練馬師</th>
            <th>評分</th>
            <th>評分變動</th>
            <th>負磅 (lb)</th>
            <th>出馬磅</th>
            <th>年齡</th>
            <th>性別</th>
            <th>WFA</th>
            <th>今季獎金</th>
            <th>優先權</th>
            <th>上次出賽至今</th>
            <th>馬主</th>
            <th>父系</th>
            <th>母系</th>
            <th>進口類別</th>
            <th>馬衣</th>
            <th>品牌</th>
            <th>配備</th>
            <th>近績</th>
            <th>退出</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

</main>

<script>
// =========================
// 1. URL 參數
// =========================
const params = new URLSearchParams(window.location.search);
const raceDate = params.get('date') || new Date().toISOString().slice(0,10);
const venue    = params.get('venue') || 'ST';
const raceNo   = Number(params.get('race') || '1');

// 初始標題（等陣有 DB 資料再 update）
document.getElementById('title-main').innerHTML =
  `<strong>第 ${raceNo} 場</strong>`;
document.getElementById('title-sub').textContent =
  `${raceDate}・${venue}`;

// =========================
// 2. 全局狀態
// =========================
const state = {
  tab: 'basic',
  raceMeta: null,         // racecard_races 一行
  entries: [],            // racecard_entries 多行
  oddsLatest: [],         // /api/odds.latest
  oddsSnapshots: []       // /api/odds.snapshots（最近 10 筆）
};

// =========================
// 3. 返回 / 重新載入
// =========================
document.getElementById('btnBack').onclick = () => {
  if (window.history.length > 1) {
    window.history.back();
  } else {
    const url = new URL(window.location.origin + '/app');
    window.location.href = url.toString();
  }
};

document.getElementById('btnReload').onclick = async () => {
  await reloadAll();
  renderCurrentTab();
};

// =========================
// 4. Tabs 控制
// =========================
const panels = {
  basic:   document.getElementById('panel-basic'),
  odds:    document.getElementById('panel-odds'),
  runners: document.getElementById('panel-runners')
};

document.getElementById('tabs').addEventListener('click', (e)=>{
  const t = e.target.closest('.tab');
  if (!t) return;
  state.tab = t.dataset.tab;
  renderTabs();
  renderCurrentTab();
});

function renderTabs(){
  [...document.getElementById('tabs').children].forEach(t =>
    t.classList.toggle('active', t.dataset.tab===state.tab)
  );
  Object.keys(panels).forEach(k =>
    panels[k].classList.toggle('active', k===state.tab)
  );
}

// =========================
// 5. 從後端取數據
// =========================

// 5.1 單日所有場次 → 揀出呢一場
async function loadRaceMeta() {
  const url = `/api/racecard/races?date=${raceDate}&venue=${venue}`;
  console.log('[race] fetch meta:', url);

  const res  = await fetch(url);
  const rows = await res.json();

  const r = rows.find(x => Number(x.race_no) === raceNo) || null;
  state.raceMeta = r;

  if (r) {
    // 更新頁面標題
    document.getElementById('title-main').innerHTML =
      `<strong>第 ${r.race_no} 場</strong> ${r.race_name_zh || ''}`;
    document.getElementById('title-sub').textContent =
      `${raceDate}・${venue}・${r.course || ''} ${r.distance_m || ''}m・${r.class_text || ''}`;
  }
}

// 5.2 取某場馬匹名單
async function loadEntries() {
  const url = `/api/racecard/entries?date=${raceDate}&race_no=${raceNo}`;
  console.log('[race] fetch entries:', url);

  const res  = await fetch(url);
  const rows = await res.json();

  state.entries = Array.isArray(rows) ? rows : [];
}

// 5.3 賠率（最新 + snapshot）
async function loadOdds() {
  const url = `/api/odds?date=${raceDate}&venue=${venue}&raceNo=${raceNo}`;
  console.log('[race] fetch odds:', url);

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error('odds api error ' + res.status);
    const data = await res.json();

    state.oddsLatest    = Array.isArray(data.latest)    ? data.latest    : [];
    state.oddsSnapshots = Array.isArray(data.snapshots) ? data.snapshots : [];
  } catch (e) {
    console.error('[race] loadOdds error:', e);
    state.oddsLatest = [];
    state.oddsSnapshots = [];
  }
}

// 同步 reload meta + entries + odds
async function reloadAll() {
  try {
    await Promise.all([loadRaceMeta(), loadEntries(), loadOdds()]);
  } catch (err) {
    console.error('[race] reload error', err);
  }
}

// =========================
// 6. Helper
// =========================
function fmtTime(ts){
  if (!ts) return '';
  // Node 會傳 ISO 字串或類似，交俾 Date 處理；如果 parse 唔到就原樣顯示
  const d = new Date(ts);
  if (Number.isNaN(d.getTime())) return ts;
  return d.toLocaleTimeString('zh-HK', { hour12:false });
}

// 快速由 horse_no 搵馬名（比 snapshot 用）
function buildHorseNameMap(){
  const map = {};
  for (const e of state.entries){
    if (e.horse_no != null){
      map[e.horse_no] = e.horse_name_zh || '';
    }
  }
  return map;
}

// =========================
// 7. 各 panel render
// =========================

function renderBasic(){
  const r = state.raceMeta;
  const box = document.getElementById('basicCards');

  if (!r) {
    box.innerHTML = `
      <div class="card">
        <p class="muted">找不到賽事資料（${raceDate}・${venue}・第 ${raceNo} 場）。</p>
      </div>`;
    return;
  }

  box.innerHTML = `
    <div class="card">
      <h3 style="margin:.2rem 0 .6rem">第 ${r.race_no} 場 ${r.race_name_zh || ''}</h3>
      <div class="kv">
        <div class="muted">賽日</div><div>${raceDate}</div>
        <div class="muted">場地</div><div>${venue}</div>
        <div class="muted">開跑時間</div><div>${(r.race_time || '').slice(0,5)}</div>
        <div class="muted">途程</div><div>${r.course || ''} ${r.distance_m || ''} m</div>
        <div class="muted">班次</div><div>${r.class_text || ''}</div>
        <div class="muted">場地狀況</div><div>${r.going || ''}</div>
        <div class="muted">參賽數</div><div>${state.entries.length}</div>
      </div>
    </div>
    <div class="card">
      <h4 style="margin:.2rem 0 .4rem">備註</h4>
      <p class="muted">（之後可以接駁公告、換騎、退賽等資訊顯示喺呢度。）</p>
    </div>`;
}

function renderRunners() {
  const tbody = document.querySelector('#runnersTable tbody');
  const list  = state.entries;

  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="27" class="muted">暫時沒有馬匹資料。</td></tr>`;
    return;
  }

  tbody.innerHTML = list.map(e => {
    const scratched = Number(e.scratched || 0) === 1;
    return `
      <tr class="${scratched ? 'is-scratched' : ''}">
        <td>${e.horse_no ?? ''}</td>
        <td>${e.horse_name_zh || ''}</td>
        <td>${e.horse_name_en || ''}</td>
        <td>${e.horse_code || ''}</td>
        <td>${e.draw ?? ''}</td>
        <td>${e.jockey_zh || ''}</td>
        <td>${e.trainer_zh || ''}</td>
        <td>${e.rating ?? ''}</td>
        <td>${e.rating_pm || ''}</td>
        <td>${e.weight_lb ?? ''}</td>
        <td>${e.declared_wt ?? ''} ${e.declared_wt_pm || ''}</td>
        <td>${e.age ?? ''}</td>
        <td>${e.sex || ''}</td>
        <td>${e.wfa || ''}</td>
        <td>${e.season_stakes || ''}</td>
        <td>${e.priority || ''}</td>
        <td>${e.days_since || ''}</td>
        <td>${e.owner || ''}</td>
        <td>${e.sire || ''}</td>
        <td>${e.dam || ''}</td>
        <td>${e.import_cat || ''}</td>
        <td>${e.silks || ''}</td>
        <td>${e.brand || ''}</td>
        <td>${e.gear || ''}</td>
        <td>${e.last6 || ''}</td>
        <td>${scratched ? '✅' : ''}</td>
      </tr>`;
  }).join('');
}

// 7.3 賠率 render
function renderOdds(){
  const tbodyLatest = document.querySelector('#oddsTable tbody');
  const tbodySnaps  = document.querySelector('#oddsSnapshotsTable tbody');
  const pill        = document.getElementById('oddsSummaryPill');

  const latest = state.oddsLatest || [];
  const snaps  = state.oddsSnapshots || [];

  if (!latest.length){
    tbodyLatest.innerHTML =
      `<tr><td colspan="5" class="muted">暫時沒有賠率資料（可能未開售或 scheduler 未更新）。</td></tr>`;
    pill.textContent = '尚未有賠率';
  } else {
    // 以馬號排序
    const sorted = [...latest].sort((a,b)=>(a.horse_no||0)-(b.horse_no||0));
    tbodyLatest.innerHTML = sorted.map(e => {
      const win = (e.win_odds ?? '').toString();
      const pla = (e.pla_odds ?? '').toString();
      const ts  = fmtTime(e.last_odds_update);
      return `
        <tr>
          <td>${e.horse_no}</td>
          <td>${e.horse_name_zh || ''}</td>
          <td>${win}</td>
          <td>${pla}</td>
          <td class="muted">${ts}</td>
        </tr>`;
    }).join('');

    const lastTs = sorted.reduce((acc,e)=>{
      if (!e.last_odds_update) return acc;
      const d = new Date(e.last_odds_update);
      if (Number.isNaN(d.getTime())) return acc;
      return (!acc || d>acc) ? d : acc;
    }, null);

    pill.textContent = lastTs
      ? `最後更新：${lastTs.toLocaleTimeString('zh-HK',{hour12:false})}`
      : '已載入';
  }

  // Snapshots：最近 10 筆
  if (!snaps.length){
    tbodySnaps.innerHTML =
      `<tr><td colspan="5" class="muted">暫時沒有 snapshot 記錄。</td></tr>`;
  } else {
    const nameMap = buildHorseNameMap();
    const sortedSnaps = [...snaps].sort(
      (a,b)=>new Date(b.snapshot_ts)-new Date(a.snapshot_ts)
    );

    tbodySnaps.innerHTML = sortedSnaps.map(s => {
      const ts = fmtTime(s.snapshot_ts);
      const horseNo = s.horse_no ?? '';
      const name = nameMap[horseNo] || '';
      const type = s.odds_type || '';
      const odds = s.odds ?? '';
      return `
        <tr>
          <td>${ts}</td>
          <td>${horseNo}</td>
          <td>${name}</td>
          <td>${type}</td>
          <td>${odds}</td>
        </tr>`;
    }).join('');
  }
}

function renderCurrentTab(){
  if (state.tab === 'basic')   renderBasic();
  if (state.tab === 'odds')    renderOdds();
  if (state.tab === 'runners') renderRunners();
}

// =========================
// 8. 初始化
// =========================
renderTabs();
reloadAll().then(() => {
  renderCurrentTab();
}).catch(err => {
  console.error(err);
  renderCurrentTab();
});
</script>

</body>
</html>
