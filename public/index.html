<!doctype html>
<html lang="zh-HK">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è³½é¦¬æ•¸æ“šé¢æ¿ï¼ˆè³½æ—¥ï¼‹æ­·å²ï¼‹é¦¬åŒ¹/é¨å¸«/ç·´é¦¬å¸«ï¼‰</title>
<style>
  :root{
    --bg: #0f1115;
    --panel: #171a21;
    --muted: #9aa4b2;
    --text: #e6ebf2;
    --primary: #4da3ff;
    --accent: #7ee081;
    --danger: #ff6b6b;
    --border: #2a2f3a;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg: #f6f7fb; --panel:#fff; --muted:#5e6a77; --text:#1b2430;
      --primary:#1864ff; --accent:#129b45; --danger:#c42525; --border:#e7eaf0;
    }
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto}

  /* ===== Top App Bar (Menu) ===== */
  .appbar{position:sticky;top:0;z-index:50;background:var(--panel);border-bottom:1px solid var(--border)}
  .appbar .row{display:flex;align-items:center;justify-content:space-between;gap:.75rem;padding:.65rem 1rem}
  .brand{font-weight:700;letter-spacing:.3px}
  .menubar{display:flex;gap:.25rem;flex-wrap:wrap}
  .menu-btn{border:1px solid var(--border);background:transparent;color:var(--text);padding:.4rem .7rem;border-radius:.6rem;cursor:pointer}
  .menu-btn[aria-current="page"]{background:rgba(77,163,255,.16);border-color:transparent}
  .menu-spacer{flex:1}

  /* ===== Secondary Controls (contextual, under menubar) ===== */
  header.controls{position:sticky;top:44px;z-index:40;display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:.6rem 1rem;border-bottom:1px solid var(--border);background:linear-gradient(0deg,var(--panel),var(--panel))}
  .btn{border:1px solid var(--border);background:transparent;color:var(--text);padding:.45rem .7rem;border-radius:.55rem;cursor:pointer}
  .btn.primary{border-color:transparent;background:var(--primary);color:#fff}
  .btn.accent{border-color:transparent;background:var(--accent);color:#0b110d}
  .btn.danger{border-color:transparent;background:var(--danger);color:#fff}
  .field{display:flex;gap:.4rem;align-items:center;background:var(--panel);border:1px solid var(--border);padding:.35rem .55rem;border-radius:.55rem}
  .field input, .field select{background:transparent;border:0;outline:0;color:var(--text);min-width:0}

  /* ===== Layouts for different views ===== */
  main{padding:1rem}
  .view{display:none}
  .view.active{display:block}

  /* Meeting layout (left list + right content) */
  .grid-meeting{display:grid;grid-template-columns:280px 1fr;gap:1rem}
  aside{background:var(--panel);border:1px solid var(--border);border-radius:.8rem;overflow:hidden}
  .aside-head{display:flex;gap:.5rem;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);padding:.65rem .8rem}
  .race-list{max-height:calc(100vh - 260px);overflow:auto}
  .race-item{padding:.65rem .8rem;border-top:1px dashed var(--border);display:grid;grid-template-columns:28px 1fr auto;gap:.5rem;align-items:center;cursor:pointer}
  .race-item:first-child{border-top:0}
  .race-item:hover{background:rgba(77,163,255,.08);}
  .race-item small{color:var(--muted)}
  .badge{font-size:.75rem;padding:.1rem .4rem;border-radius:.35rem;border:1px solid var(--border);color:var(--muted)}
  .badge.live{color:#fff;background:var(--danger);border-color:transparent}
  section#content{background:var(--panel);border:1px solid var(--border);border-radius:.8rem;min-height:240px;padding:1rem}
  .muted{color:var(--muted)}
  .hint{max-width:480px;font-size:.95rem;line-height:1.6}

  /* Horses/Jockeys/Trainers views */
  .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.75rem}
  .table-wrap{background:var(--panel);border:1px solid var(--border);border-radius:.8rem;overflow:hidden}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid var(--border);padding:.55rem .4rem;text-align:left}
  .table th{color:var(--muted);font-weight:600}

  /* History drawer */
  .drawer{position:fixed;right:0;top:0;height:100%;width:min(420px,92vw);background:var(--panel);border-left:1px solid var(--border);transform:translateX(100%);transition:.28s ease;z-index:60}
  .drawer.open{transform:none}
  .drawer header{position:sticky;top:0}
  .history-list{padding:.75rem;display:flex;flex-direction:column;gap:.5rem;max-height:calc(100% - 64px);overflow:auto}
  .history-item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);padding:.6rem .7rem;border-radius:.55rem}
  .empty{padding:1rem;color:var(--muted)}

  /* ===== é ‚éƒ¨æ­·å²æ—¥æœŸ Modal ===== */
  .modal-backdrop{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,.45);
    z-index:70;
  }
  .modal-backdrop.open{display:flex;}
  .modal{
    background:var(--panel);
    border-radius:.8rem;
    border:1px solid var(--border);
    padding:1rem 1.1rem;
    min-width:260px;
    max-width:90vw;
    box-shadow:0 18px 40px rgba(0,0,0,.55);
  }
  .modal header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:.6rem;
  }
  .modal-title{font-weight:600}
  .modal-body{margin-bottom:.8rem}
  .modal-footer{display:flex;justify-content:flex-end;gap:.5rem}

  @media (max-width: 980px){
    .grid-meeting{grid-template-columns:1fr}
    .race-list{max-height:unset}
  }
  .is-hidden { display: none !important; }

</style>
</head>
<body>

<!-- ===== App Menu Bar ===== -->
<div class="appbar">
  <div class="row">
    <div class="brand">HKJC é¢æ¿</div>
    <nav class="menubar" id="menubar">
      <button class="menu-btn" data-view="meeting" aria-current="page">è³½æ—¥</button>
      <!-- ğŸ”¸ é ‚éƒ¨æ­·å²ï¼šåªç”¨åšŸæ€æ—¥æœŸ -->
      <button class="menu-btn" id="btnTopHistory" type="button">æ­·å²</button>
      <button class="menu-btn" data-view="horses">é¦¬åŒ¹</button>
      <button class="menu-btn" data-view="jockeys">é¨å¸«</button>
      <button class="menu-btn" data-view="trainers">ç·´é¦¬å¸«</button>
      <button class="menu-btn" data-view="stats">çµ±è¨ˆ</button>
      <span class="menu-spacer"></span>
      <button class="menu-btn" data-view="settings">ç³»çµ±</button>
    </nav>
  </div>
</div>

<!-- ===== Context controls ===== -->
<header class="controls is-hidden" id="controls">
  <div class="left" id="controls-left"></div>
  <div class="right" id="controls-right"></div>
</header>

<main>
  <!-- ===== View: Meeting ===== -->
  <div class="view active" id="view-meeting">
    <div class="grid-meeting">
      <aside>
        <div class="aside-head">
          <strong>è³½æ—¥ç¸½è¦½</strong>
          <span class="muted" id="summary"></span>
        </div>
        <div id="raceList" class="race-list"></div>
      </aside>

      <section id="content">
        <h3 style="margin-top:.2rem;">è³½äº‹è©³æƒ…</h3>
        <p class="muted hint">
          â‘  å…ˆå–ºå·¦é‚Šæ€ <strong>è³½äº‹å ´æ¬¡</strong>ï¼ˆç¬¬ 1 å ´ã€ç¬¬ 2 å ´â€¦ï¼‰<br>
          â‘¡ æœƒè‡ªå‹•è·³å» <strong>æ–°ä¸€é </strong> é¡¯ç¤ºï¼š<strong>åŸºæœ¬è³‡æ–™ã€è³ ç‡ / æŠ•æ³¨æ± ã€é¦¬åŒ¹åå–®</strong><br>
          â‘¢ å¦‚è¦æ”¹è³½æ—¥ / å ´åœ°ï¼Œå–ºé ‚éƒ¨æ§åˆ¶åˆ—é‡æ–°é¸æ“‡å³å¯ã€‚
        </p>
      </section>
    </div>
  </div>

  <!-- ===== View: Horses ===== -->
  <div class="view" id="view-horses">
    <div class="toolbar">
      <div class="field"><span class="muted">æœå°‹</span><input id="qHorses" placeholder="é¦¬å / ç·¨è™Ÿ / è¡€çµ±" /></div>
      <div class="field"><span class="muted">æ€§åˆ¥</span>
        <select id="sexFilter"><option value="">å…¨éƒ¨</option><option>é–¹</option><option>é›„</option><option>é›Œ</option></select>
      </div>
      <div class="field"><span class="muted">è©•åˆ† â‰¥</span><input id="ratingMin" type="number" min="0" max="140" style="width:84px"></div>
    </div>
    <div class="table-wrap">
      <table class="table" id="horsesTable">
        <thead><tr>
          <th>ç·¨è™Ÿ</th><th>é¦¬åï¼ˆä¸­/è‹±ï¼‰</th><th>æ€§åˆ¥</th><th>å¹´é½¡</th><th>è©•åˆ†</th><th>ç·´é¦¬å¸«</th><th>è¿‘ç¸¾</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ===== View: Jockeys ===== -->
  <div class="view" id="view-jockeys">
    <div class="toolbar">
      <div class="field"><span class="muted">æœå°‹</span><input id="qJockeys" placeholder="é¨å¸«å / åœ‹ç±" /></div>
      <div class="field"><span class="muted">è¦‹ç¿’</span>
        <select id="claimFilter"><option value="">å…¨éƒ¨</option><option value="Y">è¦‹ç¿’</option><option value="N">éè¦‹ç¿’</option></select>
      </div>
    </div>
    <div class="table-wrap">
      <table class="table" id="jockeysTable">
        <thead><tr>
          <th>#</th><th>é¨å¸«</th><th>å‡ºè³½</th><th>å† </th><th>äº</th><th>å­£</th><th>å† ç‡</th><th>ç´¯è¨ˆçé‡‘</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ===== View: Trainers ===== -->
  <div class="view" id="view-trainers">
    <div class="toolbar">
      <div class="field"><span class="muted">æœå°‹</span><input id="qTrainers" placeholder="ç·´é¦¬å¸«å" /></div>
    </div>
    <div class="table-wrap">
      <table class="table" id="trainersTable">
        <thead><tr>
          <th>#</th><th>ç·´é¦¬å¸«</th><th>å‡ºè³½</th><th>å† </th><th>äº</th><th>å­£</th><th>å† ç‡</th><th>ç´¯è¨ˆçé‡‘</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ===== View: Stats ===== -->
  <div class="view" id="view-stats">
    <div class="table-wrap" style="padding:1rem;">
      <h3 style="margin-top:.2rem;">çµ±è¨ˆï¼ˆç¤ºä¾‹ï¼‰</h3>
      <p class="muted">é€™è£¡å¯æ¥ä½ çš„è³‡æ–™åº«åšè¶¨å‹¢åœ–ï¼ˆå¦‚ï¼šæ¯å ´æŠ•æ³¨é¡ã€å„ç­æ¬¡å‹ç‡ç­‰ï¼‰ã€‚</p>
      <ul class="muted">
        <li>æ´»èºé¦¬åŒ¹ï¼š<span id="stat-horses">â€”</span></li>
        <li>åœ¨å†Šé¨å¸«ï¼š<span id="stat-jockeys">â€”</span></li>
        <li>åœ¨å†Šç·´é¦¬å¸«ï¼š<span id="stat-trainers">â€”</span></li>
      </ul>
    </div>
  </div>

  <!-- ===== View: Settings ===== -->
  <div class="view" id="view-settings">
    <div class="table-wrap" style="padding:1rem;">
      <h3 style="margin-top:.2rem;">ç³»çµ±è¨­å®š</h3>
      <div style="display:grid;grid-template-columns:160px 1fr;gap:.35rem .8rem;margin-top:.6rem;">
        <div class="muted">API ç¯€æµï¼ˆç§’ï¼‰</div><div><input id="throttle" type="number" value="30" style="width:96px"></div>
        <div class="muted">è‡ªå‹•åˆ·æ–°</div>
        <div><select id="autoRefresh"><option value="off">é—œé–‰</option><option value="on">é–‹å•Ÿ</option></select></div>
      </div>
      <p class="muted" style="margin-top:1rem;">
        æŠŠä½ çš„æŠ“å–ç«¯é» / å¾Œç«¯ API ä½å€å¡«åœ¨ JS çš„ <code>fetch</code> å€æ®µå³å¯ã€‚
      </p>
    </div>
  </div>
</main>

<!-- ğŸ”´ é ‚éƒ¨æ­·å²ï¼šæ—¥æœŸé¸æ“‡ Modal -->
<div class="modal-backdrop" id="historyModal">
  <div class="modal">
    <header>
      <div class="modal-title">é¸æ“‡æ­·å²è³½æ—¥</div>
      <button class="btn" type="button" id="btnHistoryClose">âœ•</button>
    </header>
    <div class="modal-body">
      <p class="muted" style="margin-top:0;margin-bottom:.4rem;">
        åªé¡¯ç¤ºæœ‰æ’ä½è³‡æ–™å˜…æ—¥æœŸï¼š
      </p>
      <select id="historyDateSelect">
        <option value="">è¼‰å…¥ä¸­â€¦</option>
      </select>
    </div>
    <div class="modal-footer">
      <button class="btn" type="button" id="btnHistoryCancel">å–æ¶ˆ</button>
      <button class="btn primary" type="button" id="btnHistoryApply">å¥—ç”¨</button>
    </div>
  </div>
</div>

<!-- LocalStorage æ­·å²æŠ½å±œï¼ˆå°å­˜ç”¨ï¼‰ -->
<div class="drawer" id="drawer">
  <header class="row" style="padding:.6rem 1rem"><strong>å°å­˜æ­·å²è³½æ—¥</strong></header>
  <div class="history-list" id="historyList">
    <div class="empty">å°šæœªå°å­˜ä»»ä½•è³½æ—¥ã€‚</div>
  </div>
</div>

<script>
/****************************
 * å…±ç”¨å·¥å…·
 ****************************/
function loadHistory(){
  try{ return JSON.parse(localStorage.getItem('hkjc_history')||'[]'); }catch(e){ return []; }
}
function saveHistory(list){
  localStorage.setItem('hkjc_history', JSON.stringify(list));
}
function demoRace(no){
  return { no, time:'--:--', course:'', distance:0, going:'', status:'é å®š' };
}

// å‚³å…¥ YYYY-MM-DDï¼Œå˜—è©¦è‡ªå‹•åˆ¤æ–·è©²æ—¥ä¿‚ ST æˆ– HVï¼ˆæœ‰éœ€è¦å¯æ“´å……ï¼‰
async function detectVenueForDate(d) {
  const tryVenues = ['ST', 'HV'];       // æœ‰å…¶ä»–å ´åœ°å¯ä»¥åŠ è½å»
  for (const v of tryVenues) {
    const url = `/api/racecard/races?date=${encodeURIComponent(d)}&venue=${encodeURIComponent(v)}`;
    try {
      const res = await fetch(url);
      if (!res.ok) continue;
      const rows = await res.json();
      if (Array.isArray(rows) && rows.length > 0) {
        return v; // å‘¢å€‹å ´åœ°æœ‰è³½äº‹ï¼Œå°±ç”¨ä½¢
      }
    } catch (_) {}
  }
  return 'ST'; // å¾Œå‚™ï¼šéƒ½æµå””åˆ°å°±å›è½ ST
}



/****************************
 * å…¨å±€ç‹€æ…‹
 ****************************/
const state = {
  view: 'meeting',
  raceDate: null,      // YYYY-MM-DD
  venue: 'ST',
  races: [],
  horses: [],
  jockeys: [],
  trainers: [],
  history: loadHistory(),
};

/****************************
 * DOM å…ƒç´ 
 ****************************/
const el = {
  menubar: document.getElementById('menubar'),
  controlsLeft: document.getElementById('controls-left'),
  controlsRight: document.getElementById('controls-right'),
  views: {
    meeting:  document.getElementById('view-meeting'),
    horses:   document.getElementById('view-horses'),
    jockeys:  document.getElementById('view-jockeys'),
    trainers: document.getElementById('view-trainers'),
    stats:    document.getElementById('view-stats'),
    settings: document.getElementById('view-settings'),
  },
  raceList: document.getElementById('raceList'),
  summary:  document.getElementById('summary'),
  horsesTableBody:   document.querySelector('#horsesTable tbody'),
  jockeysTableBody:  document.querySelector('#jockeysTable tbody'),
  trainersTableBody: document.querySelector('#trainersTable tbody'),
  drawer: document.getElementById('drawer'),
  historyList: document.getElementById('historyList'),
};

// ===== æ’ä½æ—¥æœŸ cache / API =====
let cachedRaceDates = null;

// e.g. /api/racecard/dates â†’ ["2025-11-15T00:00:00.000Z", ...]
async function fetchRaceDates() {
  if (cachedRaceDates) return cachedRaceDates;
  try {
    const res = await fetch('/api/racecard/dates');
    const arr = await res.json();
    cachedRaceDates = (Array.isArray(arr) ? arr : []).map(d =>
      typeof d === 'string' ? d.slice(0,10) : d
    );
  } catch (e) {
    console.error('fetchRaceDates error', e);
    cachedRaceDates = [];
  }
  return cachedRaceDates;
}

async function fetchLatestRaceDate() {
  const dates = await fetchRaceDates();
  if (dates.length) state.raceDate = dates[0];
  else state.raceDate = new Date().toISOString().slice(0,10);
}

/****************************
 * è®€å–æŸæ—¥æ’ä½
 ****************************/
async function loadRacesFromServer() {
  try {
    const d = (state.raceDate || '').slice(0,10);
    const url = `/api/racecard/races?date=${encodeURIComponent(d)}&venue=${encodeURIComponent(state.venue)}`;
    console.log('[loadRacesFromServer] GET', url);

    const res = await fetch(url);
    if (!res.ok) {
      console.error('HTTP error', res.status, await res.text());
      state.races = Array.from({length:12},(_,i)=>demoRace(i+1));
      renderMeeting();
      return;
    }

    const rows = await res.json();
    if (!rows.length) {
      state.races = Array.from({length:12},(_,i)=>demoRace(i+1));
    } else {
      state.races = rows.map(r => ({
        no:       r.race_no,
        time:     (r.race_time || '').slice(0,5),
        course:   r.course || '',
        distance: r.distance_m || 0,
        going:    r.going || '',
        status:   r.class_text || 'é å®š',
      }));
    }
    renderMeeting();
  } catch (e) {
    console.error('loadRacesFromServer error', e);
    state.races = Array.from({length:12},(_,i)=>demoRace(i+1));
    renderMeeting();
  }
}

/****************************
 * æ§åˆ¶åˆ—
 ****************************/
function renderControls(){
  const left = el.controlsLeft, right = el.controlsRight;
  left.innerHTML = ''; right.innerHTML = '';

  if (state.view === 'meeting') {
    // ä¸å†é¡¯ç¤ºæ—¥æœŸ/å ´åœ°/å°å­˜
    // left.innerHTML = `<strong>è³½æ—¥</strong>`; // æƒ³é¡¯ç¤ºå­—å¯ç•™é€™è¡Œ
  } else if (state.view === 'horses') {
    left.innerHTML = `<strong>é¦¬åŒ¹æ¸…å–®</strong>`;
  } else if (state.view === 'jockeys') {
    left.innerHTML = `<strong>é¨å¸«åå–®</strong>`;
  } else if (state.view === 'trainers') {
    left.innerHTML = `<strong>ç·´é¦¬å¸«åå–®</strong>`;
  } else if (state.view === 'stats') {
    left.innerHTML = `<strong>çµ±è¨ˆ</strong>`;
  } else if (state.view === 'settings') {
    left.innerHTML = `<strong>ç³»çµ±è¨­å®š</strong>`;
  }

  // âœ… meeting ä¸å†æ›ä»»ä½•æ§ä»¶äº‹ä»¶
}

/****************************
 * Menu åˆ‡ view
 ****************************/
el.menubar.addEventListener('click', (e)=>{
  const btn = e.target.closest('.menu-btn');
  if (!btn) return;
  if (btn.id === 'btnTopHistory') return; // é ‚éƒ¨æ­·å²å””å–ºå‘¢åº¦è™•ç†

  const view = btn.dataset.view;
  if (!view) return;
  state.view = view;
  renderView();
});

function renderView(){
  [...el.menubar.querySelectorAll('.menu-btn')]
    .forEach(b => b.setAttribute('aria-current', b.dataset.view === state.view ? 'page' : 'false'));

  Object.entries(el.views)
    .forEach(([k,v]) => v.classList.toggle('active', k === state.view));

  renderControls();

  if (state.view === 'meeting')  renderMeeting();
  if (state.view === 'horses')   renderHorses();
  if (state.view === 'jockeys')  renderJockeys();
  if (state.view === 'trainers') renderTrainers();
}

/****************************
 * Meeting view
 ****************************/
function renderMeeting(){
  el.summary.textContent = `${state.raceDate || '--'}ãƒ»${state.venue}ãƒ»å…± ${state.races.length} å ´`;
  el.raceList.innerHTML = '';
  state.races.forEach(r=>{
    const row = document.createElement('div');
    row.className = 'race-item';
    row.innerHTML = `
      <div>${r.no}</div>
      <div>
        <div><strong>${r.time}</strong>ã€€<small>${r.course} ${r.distance}m</small></div>
        <small class="muted">å ´åœ°ï¼š${r.going}</small>
      </div>
      <div><span class="badge ${r.status==='é–‹è·‘'?'live':''}">${r.status}</span></div>`;
    row.addEventListener('click', ()=>{
      const url = new URL(window.location.origin + '/race.html');
      url.searchParams.set('date', state.raceDate);
      url.searchParams.set('venue', state.venue);
      url.searchParams.set('race', String(r.no));
      window.location.href = url.toString();
    });
    el.raceList.appendChild(row);
  });
}

/****************************
 * Horses / Jockeys / Trainersï¼ˆæš«æ™‚åª filter æœ¬åœ° stateï¼‰
 ****************************/
function renderHorses(){
  const sex = document.getElementById('sexFilter')?.value || '';
  const min = Number(document.getElementById('ratingMin')?.value || 0);
  const q = (document.getElementById('qHorses')?.value || '').toLowerCase();
  const list = state.horses.filter(h =>
    (!sex || h.sex === sex) &&
    h.rating >= min &&
    (h.name_zh?.includes(q) || (h.name_en||'').toLowerCase().includes(q) || (h.code||'').toLowerCase().includes(q))
  );
  el.horsesTableBody.innerHTML = list.map(h=>`
    <tr>
      <td>${h.code||''}</td>
      <td>${h.name_zh||''} <span class="muted">/ ${h.name_en||''}</span></td>
      <td>${h.sex||''}</td>
      <td>${h.age||''}</td>
      <td>${h.rating||''}</td>
      <td>${h.trainer||''}</td>
      <td>${h.form||''}</td>
    </tr>`).join('');
  const stat = document.getElementById('stat-horses');
  if (stat) stat.textContent = state.horses.length;
}

function renderJockeys(){
  const claim = document.getElementById('claimFilter')?.value || '';
  const q = (document.getElementById('qJockeys')?.value || '').toLowerCase();
  const list = state.jockeys.filter(j =>
    (!claim || (claim === 'Y' ? j.claim : !j.claim)) &&
    j.name.toLowerCase().includes(q)
  );
  el.jockeysTableBody.innerHTML = list.map(j=>{
    const winRate = j.runs ? ((j.win/j.runs)*100).toFixed(1)+'%' : 'â€”';
    return `<tr>
      <td>${j.id}</td>
      <td>${j.name}${j.claim ? ' <span class="muted">(è¦‹ç¿’)</span>' : ''}</td>
      <td>${j.runs}</td><td>${j.win}</td><td>${j.place2}</td><td>${j.place3}</td>
      <td>${winRate}</td><td>${j.prize.toLocaleString()}</td>
    </tr>`;
  }).join('');
  const stat = document.getElementById('stat-jockeys');
  if (stat) stat.textContent = state.jockeys.length;
}

function renderTrainers(){
  const q = (document.getElementById('qTrainers')?.value || '').toLowerCase();
  const list = state.trainers.filter(t => t.name.toLowerCase().includes(q));
  el.trainersTableBody.innerHTML = list.map(t=>{
    const winRate = t.runs ? ((t.win/t.runs)*100).toFixed(1)+'%' : 'â€”';
    return `<tr>
      <td>${t.id}</td><td>${t.name}</td><td>${t.runs}</td>
      <td>${t.win}</td><td>${t.place2}</td><td>${t.place3}</td>
      <td>${winRate}</td><td>${t.prize.toLocaleString()}</td>
    </tr>`;
  }).join('');
  const stat = document.getElementById('stat-trainers');
  if (stat) stat.textContent = state.trainers.length;
}

/****************************
 * å°å­˜æ­·å²æŠ½å±œï¼ˆç”¨ localStorageï¼‰
 ****************************/
function toggleDrawer(open){ el.drawer.classList.toggle('open', open); }

function renderHistory(){
  const list = state.history;
  el.historyList.innerHTML = '';
  if (!list.length) {
    el.historyList.innerHTML = `<div class="empty">å°šæœªå°å­˜ä»»ä½•è³½æ—¥ã€‚</div>`;
    return;
  }
  list.slice().reverse().forEach(item=>{
    const row = document.createElement('div');
    row.className = 'history-item';
    row.innerHTML = `
      <div>
        <strong>${item.raceDate}</strong>ãƒ»<span class="muted">${item.venue}</span>
        <div class="muted">å…± ${item.races.length} å ´</div>
      </div>
      <div>
        <button class="btn" data-act="preview">å¥—ç”¨</button>
        <button class="btn danger" data-act="delete">åˆªé™¤</button>
      </div>`;
    row.querySelector('[data-act="preview"]').onclick = ()=>{
      state.view='meeting';
      state.raceDate=item.raceDate;
      state.venue=item.venue;
      state.races=item.races;
      renderView();
      toggleDrawer(false);
    };
    row.querySelector('[data-act="delete"]').onclick = ()=>{
      const idx = state.history.findIndex(x=>x.id===item.id);
      if (idx>-1){
        state.history.splice(idx,1);
        saveHistory(state.history);
        renderHistory();
      }
    };
    el.historyList.appendChild(row);
  });
}

function archiveToday(){
  const snapshot = {
    id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())),
    raceDate: state.raceDate,
    venue: state.venue,
    races: state.races,
  };
  state.history.push(snapshot);
  saveHistory(state.history);
  renderHistory();
  toggleDrawer(true);
}

/****************************
 * é ‚éƒ¨ã€Œæ­·å²ã€Modalï¼ˆé¸æ“‡æœ‰æ’ä½æ—¥æœŸï¼‰
 ****************************/
const historyModal   = document.getElementById('historyModal');
const historySelect  = document.getElementById('historyDateSelect');
const btnTopHistory  = document.getElementById('btnTopHistory');
const btnHistClose   = document.getElementById('btnHistoryClose');
const btnHistCancel  = document.getElementById('btnHistoryCancel');
const btnHistApply   = document.getElementById('btnHistoryApply');

function openHistoryModal(){ historyModal.classList.add('open'); document.body.style.overflow='hidden'; }
function closeHistoryModal(){ historyModal.classList.remove('open'); document.body.style.overflow=''; }

async function populateHistoryDates(){
  historySelect.innerHTML = `<option value="">è¼‰å…¥ä¸­â€¦</option>`;
  const dates = await fetchRaceDates();
  if (!dates.length){
    historySelect.innerHTML = `<option value="">æš«æ™‚å†‡æ­·å²è³½æ—¥</option>`;
    return;
  }
  historySelect.innerHTML = dates.map(d=>`<option value="${d}">${d}</option>`).join('');
  historySelect.value = dates[0];
}

/****************************
 * åˆå§‹åŒ–
 ****************************/
async function init(){
  try {
    await fetchLatestRaceDate();
    // ğŸ”¸ æ–°å¢ï¼šæ ¹æ“š raceDate è‡ªå‹•åµæ¸¬å ´åœ°
    state.venue = await detectVenueForDate(state.raceDate);
    await loadRacesFromServer();
  } catch(e){
    console.error('init error', e);
    state.races = Array.from({length:12},(_,i)=>demoRace(i+1));
  }
  renderView();

  // é ‚éƒ¨ã€Œæ­·å²ã€æ£äº‹ä»¶
  if (btnTopHistory) {
    btnTopHistory.addEventListener('click', async ()=>{
      await populateHistoryDates();
      openHistoryModal();
    });
  }
  if (btnHistClose)  btnHistClose.addEventListener('click', closeHistoryModal);
  if (btnHistCancel) btnHistCancel.addEventListener('click', closeHistoryModal);
  if (btnHistApply){
    btnHistApply.addEventListener('click', async ()=>{
      const d = historySelect.value;
      if (!d) return;
      state.raceDate = d;
      state.venue = await detectVenueForDate(d);
      closeHistoryModal();
      await loadRacesFromServer();
    });
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
